{
  "question": "To analyze digital engagement trends, please group customers into quarterly cohorts based on their tenure and identify digital natives. For each combination of cohort with whether they are digital natives, show the cohort quarter, bool value, the cohort size, engagement score, the percentage of the cohort with high engagement, and high-engagement percentage broken down by digital native status.",
  "ambiguity_check": {
    "is_ambiguous": true,
    "reason": "Mehrere für eine korrekte SQL-Abfrage essenzielle Punkte sind nicht eindeutig definiert: (1) „quarterly cohorts based on their tenure“ und „Cohort Quarter“ sind nur als Konzept beschrieben, aber es ist unklar, welches Datumsfeld als Referenz für die Kohortenbildung genutzt werden soll (scoredate, timemark, decidedate, nextcheck) und wie genau „scoring date minus tenure years“ in ein Quartal umgerechnet werden soll. (2) „digital natives“ ist im Schema/Domain-Wissen nicht als Begriff definiert; es gibt nur „Digital First Customer“ mit konkreten Kriterien. Ob „digital natives“ = „Digital First Customer“ ist, ist unklar. (3) „engagement score“ ist nicht eindeutig: Es existiert eine definierte Formel für CES, aber es ist nicht gesagt, ob genau CES gemeint ist oder ein anderes Engagement-Maß. (4) „percentage of the cohort with high engagement“: Der Schwellenwert ist zwar als CES > 0.7 definiert, aber nur falls tatsächlich CES das Engagement-Maß ist. (5) „high-engagement percentage broken down by digital native status“ überschneidet sich mit der bereits geforderten Gruppierung nach digital native; unklar ist, ob zusätzlich innerhalb jeder Kohorte auch beide Statuswerte in separaten Spalten (Pivot) erwartet werden oder ob die Gruppierung bereits ausreicht.",
    "questions": [
      "Welches Datumsfeld soll für die Kohorten-Quartalsberechnung verwendet werden (z. B. core_record.scoredate, timemark oder decidedate), und soll das Kohortenquartal exakt als QUARTER(scoredate - tenureyrs * 1 year) berechnet werden?",
      "Wie definieren Sie „digital natives“ konkret: Soll das den Domain-Begriff „Digital First Customer“ (onlineuse oder mobileuse = 'High' UND autopay = 'Yes') verwenden, oder eine andere Definition?"
    ]
  },
  "generated_sql": "WITH base AS (\n  SELECT\n    CASE\n      WHEN (\n        (json_extract(bt.chaninvdatablock, '$.onlineuse') = 'High'\n         OR json_extract(bt.chaninvdatablock, '$.mobileuse') = 'High')\n        AND json_extract(bt.chaninvdatablock, '$.autopay') = 'Yes'\n      ) THEN 1 ELSE 0\n    END AS is_digital_native,\n    (\n      0.4 * cah.produsescore\n      + 0.3 * cah.chanusescore\n      + 0.2 * bt.bankrelscore\n      + 0.1 * (cah.custservint / 10.0)\n    ) AS ces\n  FROM core_record cr\n  JOIN employment_and_income ei ON cr.coreregistry = ei.emplcoreref\n  JOIN expenses_and_assets ea ON ei.emplcoreref = ea.expemplref\n  JOIN bank_and_transactions bt ON ea.expemplref = bt.bankexpref\n  JOIN credit_and_compliance cc ON bt.bankexpref = cc.compbankref\n  JOIN credit_accounts_and_history cah ON cc.compbankref = cah.histcompref\n)\nSELECT\n  is_digital_native,\n  COUNT(*) AS cohort_size,\n  AVG(ces) AS avg_engagement,\n  100.0 * AVG(CASE WHEN ces > 0.7 THEN 1.0 ELSE 0.0 END) AS pct_high_engagement\nFROM base\nGROUP BY is_digital_native\nORDER BY is_digital_native",
  "validation": {
    "is_valid": true,
    "errors": [],
    "severity": "low",
    "suggestions": [
      "Optional: json_extract(...) Werte ggf. mit COALESCE absichern (z.B. COALESCE(json_extract(bt.chaninvdatablock,'$.autopay'),'No')), falls chaninvdatablock NULL ist; sonst wird is_digital_native automatisch 0.",
      "Optional: Wenn produsescore/chanusescore/bankrelscore NULL sein können, COALESCE verwenden, damit ces nicht NULL wird (z.B. COALESCE(cah.produsescore,0)).",
      "Optional: Prüfen, ob die Skalierung von custservint (/10.0) fachlich passt; aktuell kann ces > 1 werden, was die Schwelle 0.7 beeinflusst."
    ]
  },
  "results": [
    {
      "is_digital_native": 0,
      "cohort_size": 715,
      "avg_engagement": 0.5465812587412587,
      "pct_high_engagement": 21.11888111888112
    },
    {
      "is_digital_native": 1,
      "cohort_size": 285,
      "avg_engagement": 0.5426698245614034,
      "pct_high_engagement": 16.842105263157894
    }
  ],
  "row_count": 2,
  "query_id": "eef9771971a2427997b753472db8b273",
  "page": 1,
  "page_size": 50,
  "total_pages": 1,
  "total_rows": 2,
  "has_next_page": false,
  "has_previous_page": false,
  "notice": " Hinweis: Ambiguity: Mehrere für eine korrekte SQL-Abfrage essenzielle Punkte sind nicht eindeutig definiert: (1) „quarterly cohorts based on their tenure“ und „Cohort Quarter“ sind nur als Konzept beschrieben, aber es ist unklar, welches Datumsfeld als Referenz für die Kohortenbildung genutzt werden soll (scoredate, timemark, decidedate, nextcheck) und wie genau „scoring date minus tenure years“ in ein Quartal umgerechnet werden soll. (2) „digital natives“ ist im Schema/Domain-Wissen nicht als Begriff definiert; es gibt nur „Digital First Customer“ mit konkreten Kriterien. Ob „digital natives“ = „Digital First Customer“ ist, ist unklar. (3) „engagement score“ ist nicht eindeutig: Es existiert eine definierte Formel für CES, aber es ist nicht gesagt, ob genau CES gemeint ist oder ein anderes Engagement-Maß. (4) „percentage of the cohort with high engagement“: Der Schwellenwert ist zwar als CES > 0.7 definiert, aber nur falls tatsächlich CES das Engagement-Maß ist. (5) „high-engagement percentage broken down by digital native status“ überschneidet sich mit der bereits geforderten Gruppierung nach digital native; unklar ist, ob zusätzlich innerhalb jeder Kohorte auch beide Statuswerte in separaten Spalten (Pivot) erwartet werden oder ob die Gruppierung bereits ausreicht.. Klärungsfragen: Welches Datumsfeld soll für die Kohorten-Quartalsberechnung verwendet werden (z. B. core_record.scoredate, timemark oder decidedate), und soll das Kohortenquartal exakt als QUARTER(scoredate - tenureyrs * 1 year) berechnet werden?, Wie definieren Sie „digital natives“ konkret: Soll das den Domain-Begriff „Digital First Customer“ (onlineuse oder mobileuse = 'High' UND autopay = 'Yes') verwenden, oder eine andere Definition?",
  "summary": "Die Abfrage segmentiert Kunden nur nach Digital-Native-Status (ohne die angefragten quartalsweisen Tenure-Kohorten): Es gibt 715 Nicht‑Digital‑Natives mit einem durchschnittlichen Engagement-Score von 0,547 und 21,12% High Engagement (CES > 0,7) sowie 285 Digital Natives mit einem durchschnittlichen Engagement von 0,543 und 16,84% High Engagement. Auffällig ist, dass Digital Natives hier trotz ähnlichem Durchschnittsscore einen niedrigeren High‑Engagement‑Anteil haben; als nächster Schritt sollte die Tenure-/Cohort-Logik (Quartal) in die SQL ergänzt werden, um die gewünschten quartalsweisen Trends und Aufschlüsselungen zu erhalten.",
  "explanation": "Builds a per-customer engagement score (CES) and a Digital Native flag (treated as Digital First) from the channel JSON fields, then returns a 2-row summary grouped only by is_digital_native: cohort_size, average CES, and percent with high engagement (CES > 0.7). No cohort quarter/time-series fields are computed because no explicit time range was provided. [BSL compliance regeneration]",
  "error": null
}