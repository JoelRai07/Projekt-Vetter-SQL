@startuml bpmn
!theme plain
skinparam backgroundColor #ffffff
skinparam activityBackgroundColor #e3f2fd
skinparam activityBorderColor #1976d2
skinparam decisionBackgroundColor #fff9c4
skinparam decisionBorderColor #fbc02d
skinparam noteBackgroundColor #f3e5f5
skinparam noteBorderColor #7b1fa2
skinparam arrowColor #1976d2

title Text2SQL System - Prozessmodell (Activity Diagram)

start
:ğŸ‘¤ User fragt Frage;
:Frontend empfÃ¤ngt Input;

:Backend: Schema laden;
if (Cache vorhanden?) then (ja)
  :Von Cache laden;
else (nein)
  :Schema aus Dateien laden;
  :Vektorisieren;
end if

if (Schema OK?) then (ja)
  :KB & Meanings laden;
else (nein)
  :âŒ Fehler zurÃ¼ckgeben;
  stop
end if

fork
  :ğŸ” Ambiguity Detection;
  :OpenAI: Ambiguity prÃ¼fen;
  :Score erhalten;
fork again
  :ğŸš€ SQL Generation (ReAct);
  :OpenAI: SQL generieren;
  :SQL-Kandidat erhalten;
end fork

:Backend: Sicherheit prÃ¼fen;
if (SQL sicher?) then (ja)
  :Schema validieren;
else (nein)
  :âŒ SQL Injection erkannt;
  stop
end if

if (Schema valid?) then (ja)
  :OpenAI: Semantic Check;
else (nein)
  :âŒ Schema-Fehler;
  stop
end if

if (Semantik OK?) then (ja)
  :Database: SQL ausfÃ¼hren;
else (nein)
  :âš ï¸ Semantik-Feedback;
  stop
end if

if (Ergebnisse OK?) then (ja)
  :Paging anwenden;
  :Results cachen;
else (nein)
  :âŒ Execution-Fehler;
  stop
end if

:Response formatieren;
:Frontend: Ergebnisse anzeigen;
:âœ… User sieht Daten;
stop

note right
  **Validierungs-Gates:**
  âœ“ Cache-Check
  âœ“ Kontext-VerfÃ¼gbarkeit
  âœ“ SQL-Security (Injection)
  âœ“ Schema-Compliance
  âœ“ Semantic Validation
  âœ“ Execution Success
  âœ“ Paging & Caching
end note

@enduml
