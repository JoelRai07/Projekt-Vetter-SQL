@startuml bpmn
!theme plain
skinparam backgroundColor #ffffff
skinparam activityBackgroundColor #e3f2fd
skinparam activityBorderColor #1976d2
skinparam decisionBackgroundColor #fff9c4
skinparam decisionBorderColor #fbc02d
skinparam noteBackgroundColor #f3e5f5
skinparam noteBorderColor #7b1fa2
skinparam arrowColor #1976d2

title Text2SQL System - Prozessmodell (6 Phasen Activity Diagram)
note top: GPT-5.2 | ReAct+RAG | 45ms (cached) | 88% Accuracy

start
:üë§ User gibt Frage ein;
note right: z.B. "Premium-Kunden mit hoher DTI"

:Frontend ‚Üí Backend;
note right: HTTP POST /query

' =================== PHASE 1: CONTEXT LOADING ===================
:üì¶ **PHASE 1: Context Loading**;

:Cache pr√ºfen (95% Hit Rate);
if (Cache Hit?) then (ja, 10ms)
  :‚úì Schema von Cache;
else (nein, 5%)
  :Schema aus Datei laden (500ms);
  :Vektorisieren (ChromaDB);
  :In Cache speichern (1h TTL);
end if

:KB & Meanings parallel laden;
if (Kontext OK?) then (ja)
  note right: schema + kb + meanings
else (nein)
  :‚ùå Fehler: Kontext nicht verf√ºgbar;
  stop
end if

' =================== PHASE 2 & 3: PARALLEL LLM PROCESSING ===================
:‚öôÔ∏è **PHASE 2 & 3: LLM Processing (PARALLEL)**;

fork
  :üîç **P2: Ambiguity Detection**;
  :OpenAI: Ist Frage mehrdeutig?;
  if (Mehrdeutig?) then (ja)
    :‚ùì Kl√§rungsfragen zur√ºck;
    stop
  else (nein)
    :‚úì Frage ist klar;
  end if
fork again
  :üöÄ **P3: SQL Generation (ReAct)**;
  :ReAct Iteration 1: Analyze;
  :Vector Search f√ºr relevante Chunks;
  :Iteration 2: Generate SQL;
  :Few-Shot Prompt + Retrieved Context;
  :OpenAI: SQL generieren;
  :‚úì generated_sql + confidence;
end fork

' =================== PHASE 4: VALIDATION (3-LAYER) ===================
:üõ°Ô∏è **PHASE 4: Validation (3-Layer)**;

:L1: SQL Guard (Regex, 10ms);
if (SQL sicher?) then (ja)
  note right: No DELETE/DROP, Known tables
else (nein)
  :‚ùå SQL Injection detected;
  stop
end if

:L2: LLM Semantic Validation;
if (Semantik OK?) then (ja)
  note right: SQL matches question, JOINs correct
else (nein - Low)
  :‚ö†Ô∏è Warning: Low confidence;
else (nein - High)
  :‚ùå Semantik-Fehler;
  stop
end if

:L3: Schema Compliance Check;
if (Schema OK?) then (ja)
else (nein)
  :‚ùå Schema-Fehler;
  stop
end if

' =================== PHASE 5: EXECUTION ===================
:‚ö° **PHASE 5: Query Execution**;

:SQLite: Query ausf√ºhren;
note right: SELECT ... LIMIT 100 OFFSET 0\n(Paging)

if (Ergebnisse vorhanden?) then (ja)
  :‚úì Rows + Pagination Info;
else (nein)
  :‚ö†Ô∏è 0 rows (m√∂glicherweise falsch);
end if

:Cache Results (TTL: 5min);
:Cache Session (TTL: 1h, f√ºr Paging);

' =================== PHASE 6: SUMMARIZATION ===================
:üìù **PHASE 6: Result Summarization** (Optional);

:OpenAI: Natural Language Summary;
:‚úì summary_text;

' =================== RESPONSE & DISPLAY ===================
:Response zusammenstellen;
note right: sql + results + summary + paging\n+ validation_score + metrics

:Frontend: Ergebnisse anzeigen;
:‚úÖ User sieht Daten;
note right: SQL Code Block\nResults Table\nSummary Text\nPaging Controls

stop

note right
  **üìä Gesamtablauf - 6 Phasen:**
  
  **Validierungs-Gates (7 Checks):**
  ‚úì 1. Cache-Verf√ºgbarkeit
  ‚úì 2. Schema-Vollst√§ndigkeit
  ‚úì 3. SQL-Injection Detection
  ‚úì 4. Schema-Compliance
  ‚úì 5. Semantic Validation
  ‚úì 6. Query-Erfolg
  ‚úì 7. Paging-Konsistenz
  
  **Timing:**
  ‚Ä¢ With Cache: 45ms
  ‚Ä¢ Without Cache: 6.2s
  ‚Ä¢ Phase 1: 500ms | 10ms (cache)
  ‚Ä¢ Phase 2-3: 4s (parallel!)
  ‚Ä¢ Phase 4: 2s (validation)
  ‚Ä¢ Phase 5: 0.5-10s (query)
  ‚Ä¢ Phase 6: 1-2s (summary)
  
  **Cost per Query:**
  ‚Ä¢ GPT-4o-mini: $0.45
  ‚Ä¢ GPT-5.2: $0.12-0.18
  ‚Ä¢ Savings: 73% ‚úÖ
end note

@enduml
