@startuml ablauf

' =================== STYLING ===================
skinparam backgroundColor #f5f5f5
skinparam sequenceArrowColor #1a73e8
skinparam actorBackgroundColor #e8f0fe
skinparam actorBorderColor #1a73e8
skinparam participantBackgroundColor #ffffff
skinparam participantBorderColor #1a73e8
skinparam noteBkgColor #fff4e6
skinparam noteBorderColor #ff9800
skinparam noteTextColor #333333
skinparam legendBackgroundColor #ffffff

title Text2SQL System - Prozessablauf mit 6 Phasen (vereinfacht)
note right of User
  **System-Version:** v2.1 (GPT-5.2, ReAct+RAG)
  **Latency:** 45ms (with cache) | 6.2s (typical)
  **Accuracy:** 88% | Cost: $0.12-0.18/query
end note

actor User as user
participant "Frontend\n(React)" as frontend
participant "Backend\n(FastAPI)" as backend
participant "LLM\nGenerator" as llm
participant "RAG\n(Vector)" as retriever
participant "Cache" as cache
participant "SQL\nGuard" as guard
participant "Database" as db
participant "ChromaDB\n(Vector)" as chroma
participant "OpenAI\nAPI\n(GPT-5.2)" as openai

user ->> frontend: üìù Frage eingeben
note right of user: z.B. "Premium-Kunden mit hoher Schuldenlast"

activate frontend
frontend ->> backend: üì§ POST /query
deactivate frontend

activate backend

note over backend: üîç Phase 1: Kontext laden
backend ->> cache: Cache pr√ºfen
activate cache
cache -->> backend: Hit/Miss
deactivate cache

alt Cache-Miss (5% Chance)
  backend ->> retriever: Schema abrufen (500ms)
  activate retriever
  retriever ->> chroma: Vector Similarity Search
  activate chroma
  chroma ->> openai: Embeddings (text-embedding-3-small)
  openai -->> chroma: Vectors
  chroma -->> retriever: Top-k Chunks
  deactivate chroma
  retriever -->> backend: schema_text
  deactivate retriever
  backend ->> cache: Cache speichern (1h TTL)
end

backend ->> backend: KB + Meanings laden (parallel, 10ms)

note over backend: üöÄ Phase 2 & 3: LLM Processing (PARALLEL zu vorherigem)
par Ambiguity Check
  backend ->> llm: Ambiguity Detection (ReAct)
  activate llm
  llm ->> openai: "Ist die Frage mehrdeutig?"
  openai -->> llm: ambiguity_score (0.0-1.0)
  llm -->> backend: Result (500ms)
  deactivate llm
else SQL Generation
  backend ->> llm: SQL Gen (ReAct Loop)
  activate llm
  note right of llm: Iteration 1: Thought‚ÜíAction‚ÜíObserve\nIteration 2: Refine context\nGenerate SQL
  llm ->> chroma: Vector Search (5 best chunks)
  chroma -->> llm: Relevant Schema Parts
  llm ->> openai: Few-Shot SQL Generation\n(Few-Shot Examples included)
  openai -->> llm: {sql, explanation, confidence}
  llm -->> backend: generated_sql (2-4s)
  deactivate llm
end

note over backend: üõ°Ô∏è Phase 4: Validierung (3-Schichten)
backend ->> guard: Level 1: SQL Guard (10ms)
note right of guard: Regex: DELETE? DROP? INSERT?\nKnown Tables only? Single Statement?
activate guard
guard -->> backend: Security Check: OK/FAIL
deactivate guard

alt SQL unsicher
  backend -->> frontend: ‚ùå Error: SQL Injection detected
  frontend ->> user: ‚ùå Anfrage konnte nicht verarbeitet werden
else SQL sicher
  backend ->> openai: Level 2: LLM Semantic Validation
  activate openai
  openai -->> backend: Semantic Check: OK/FAIL (1-2s)
  deactivate openai
  
  alt Semantik OK
    note over backend: ‚ö° Phase 5: Ausf√ºhrung
    backend ->> db: Execute SQL (500ms-10s)
    activate db
    db -->> backend: Results [{...}, {...}]
    deactivate db
    
    backend ->> cache: Level 3: Cache Results (TTL: 5min)
    activate cache
    cache -->> backend: ‚úì Cached
    deactivate cache
    
    backend ->> llm: Phase 6: Summarization (optional, 1-2s)
    activate llm
    llm ->> openai: "Schreibe nat√ºrlichsprachliche Zusammenfassung"
    openai -->> llm: summary_text
    llm -->> backend: ‚úì
    deactivate llm
  else Semantik FAIL
    backend -->> frontend: ‚ö†Ô∏è Low Confidence: Self-Correction Loop
  end
end

deactivate backend

backend -->> frontend: üì• QueryResponse\n{sql, results, summary, paging, metrics}

activate frontend
frontend ->> user: ‚úÖ Ergebnisse anzeigen\n(SQL, Table, Paging, Summary)
deactivate frontend

note bottom of user
  **Gesamtlatenz:**
  - Mit Cache (95%): 45ms
  - Ohne Cache (5%): 6.2s
  - Durchschnitt: 0.5s
  
  **6 Phasen:**
  1Ô∏è‚É£ Context Loading (500ms | 10ms)
  2Ô∏è‚É£ Ambiguity Detection (1s parallel)
  3Ô∏è‚É£ SQL Generation (2-4s parallel)
  4Ô∏è‚É£ Validation (2s)
  5Ô∏è‚É£ Execution (0.5-10s)
  6Ô∏è‚É£ Summarization (1-2s optional)
end note

@enduml