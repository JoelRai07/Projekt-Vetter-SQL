@startuml ablauf
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Sequence.puml

' =================== STYLING ===================
skinparam backgroundColor #f5f5f5
skinparam sequenceArrowColor #1a73e8
skinparam actorBackgroundColor #e8f0fe
skinparam actorBorderColor #1a73e8
skinparam participantBackgroundColor #ffffff
skinparam participantBorderColor #1a73e8
skinparam noteBkgColor #fff4e6
skinparam noteBorderColor #ff9800
skinparam noteTextColor #333333
skinparam legendBackgroundColor #ffffff

title Text2SQL System - Prozessablauf (vereinfacht)

actor User as user
participant "Frontend\n(React)" as frontend
participant "Backend\n(FastAPI)" as backend
participant "LLM\nGenerator" as llm
participant "RAG\n(Vector)" as retriever
participant "Cache" as cache
participant "SQL\nGuard" as guard
participant "Database" as db
participant "OpenAI\nAPI" as openai

user ->> frontend: üìù Frage eingeben

activate frontend
frontend ->> backend: üì§ POST /query
deactivate frontend

activate backend

note over backend: üîç Phase 1: Kontext laden
backend ->> cache: Cache pr√ºfen
activate cache
cache -->> backend: Hit/Miss
deactivate cache

alt Cache-Miss
  backend ->> retriever: Schema abrufen
  activate retriever
  retriever ->> openai: Embeddings
  openai -->> retriever: ‚úì
  retriever -->> backend: schema_text
  deactivate retriever
end

backend ->> backend: KB + Meanings laden

note over backend: üöÄ Phase 2: LLM Processing (Parallel)
par Ambiguity Check
  backend ->> llm: Ambiguity
  activate llm
  llm ->> openai: Analyze
  openai -->> llm: score
  llm -->> backend: ‚úì
  deactivate llm
else SQL Generation
  backend ->> llm: SQL Gen (ReAct)
  activate llm
  llm ->> openai: Generate
  openai -->> llm: SQL
  llm -->> backend: ‚úì
  deactivate llm
end

note over backend: üõ°Ô∏è Phase 3: Validierung
backend ->> guard: Security Check
activate guard
guard -->> backend: OK/FAIL
deactivate guard

alt SQL sicher
  note over backend: ‚ö° Phase 4: Ausf√ºhrung
  backend ->> db: Execute SQL
  activate db
  db -->> backend: Results
  deactivate db
  
  backend ->> cache: Cache Results
  activate cache
  cache -->> backend: ‚úì
  deactivate cache
else SQL unsicher
  backend -->> frontend: ‚ùå Error
end

deactivate backend

backend -->> frontend: üì• QueryResponse

activate frontend
frontend ->> user: ‚úÖ Ergebnisse anzeigen
deactivate frontend

note right of user
  **5 Phasen:**
  1Ô∏è‚É£ Kontext laden + Cache
  2Ô∏è‚É£ LLM Parallel (Ambiguity + SQL)
  3Ô∏è‚É£ Sicherheits-Validierung
  4Ô∏è‚É£ Query Execution
  5Ô∏è‚É£ Response + Cache
end note

@enduml