@startuml ablauf

' =================== STYLING ===================
skinparam backgroundColor #f9fafb
skinparam sequenceArrowColor #2563eb
skinparam sequenceLifeLineBorderColor #94a3b8
skinparam actorBackgroundColor #dbeafe
skinparam actorBorderColor #2563eb
skinparam participantBackgroundColor #ffffff
skinparam participantBorderColor #64748b
skinparam noteBkgColor #fef3c7
skinparam noteBorderColor #f59e0b
skinparam noteTextColor #1f2937
skinparam legendBackgroundColor #ffffff
skinparam boxPadding 10
skinparam sequenceGroupBackgroundColor #f0f9ff
skinparam sequenceGroupBorderColor #0284c7
skinparam dividerBackgroundColor #e0f2fe
skinparam dividerFontColor #0369a1
skinparam dividerFontSize 14
skinparam dividerFontStyle bold

title Text2SQL System - Prozessablauf mit 6 Phasen

note across
  <b>System:</b> v2.1 (GPT-5.2, ReAct+RAG) | <b>Latency:</b> 45ms (cached) / 6.2s (typical) | <b>Accuracy:</b> 88% | <b>Cost:</b> $0.12-0.18/query
end note

actor "üë§ User" as user
box "Frontend Layer" #e0f2fe
  participant "React\nApp" as frontend
end box

box "Backend Layer" #fef3c7
  participant "FastAPI\nBackend" as backend
  participant "Cache\n(Redis)" as cache
  participant "SQL\nGuard" as guard
end box

box "AI Layer" #f3e8ff
  participant "LLM\nGenerator" as llm
  participant "RAG\nRetriever" as retriever
  participant "OpenAI\nGPT-5.2" as openai
end box

box "Data Layer" #dcfce7
  participant "ChromaDB\nVector Store" as chroma
  participant "SQLite\nDatabase" as db
end box

user ->> frontend: üìù Frage eingeben
note right of user
  Beispiel:
  "Premium-Kunden mit
  hoher Schuldenlast"
end note

activate frontend
frontend ->> backend: POST /query
deactivate frontend

activate backend

== üîç PHASE 1: Context Loading ==

group Kontext laden [Cache: 95% Hit Rate]
  backend ->> cache: Cache-Pr√ºfung
  activate cache
  cache -->> backend: Hit (95%) / Miss (5%)
  deactivate cache
  
  alt Cache-Miss (5%)
    backend ->> retriever: Schema abrufen
    activate retriever
    retriever ->> chroma: Vector Similarity Search
    activate chroma
    chroma ->> openai: text-embedding-3-small
    openai -->> chroma: Vectors
    chroma -->> retriever: Top-k Chunks
    deactivate chroma
    retriever -->> backend: schema_text
    deactivate retriever
    backend ->> cache: Speichern (TTL: 1h)
    note right: 500ms
  else Cache-Hit (95%)
    note right: 10ms
  end
  
  backend ->> backend: KB + Column Meanings laden
  note right: 10ms (parallel)
end group

== üöÄ PHASE 2 & 3: LLM Processing (Parallel) ==

par Ambiguity Detection (Phase 2)
  group Mehrdeutigkeitserkennung [ReAct Agent]
    backend ->> llm: Ambiguity Check
    activate llm
    llm ->> openai: "Ist die Frage mehrdeutig?"
    note right
      Pr√ºft auf:
      - Unklare Begriffe
      - Fehlende Kontext
      - Mehrere Interpretationen
    end note
    openai -->> llm: ambiguity_score (0.0-1.0)
    llm -->> backend: Result
    deactivate llm
    note right: ~500ms
  end group
else SQL Generation (Phase 3)
  group SQL-Generierung [ReAct + RAG]
    backend ->> llm: Generate SQL
    activate llm
    
    note right of llm
      <b>ReAct Loop:</b>
      1. Thought: Analysiere Frage
      2. Action: Hole relevanten Context
      3. Observe: Verfeinere Verst√§ndnis
      4. Generate: Erstelle SQL
    end note
    
    llm ->> chroma: Vector Search (Top-5)
    chroma -->> llm: Relevante Schema-Teile
    llm ->> openai: Few-Shot Prompt
    openai -->> llm: {sql, explanation, confidence}
    llm -->> backend: generated_sql
    deactivate llm
    note right: 2-4s
  end group
end

== üõ°Ô∏è PHASE 4: Validation (3-Layer Security) ==

group Layer 1: SQL Guard [Regex-basiert]
  backend ->> guard: Security Check
  activate guard
  note right of guard
    <b>Pr√ºfungen:</b>
    ‚úì Keine DELETE/DROP/INSERT
    ‚úì Nur SELECT/WITH erlaubt
    ‚úì Bekannte Tabellen
    ‚úì Single Statement
  end note
  guard -->> backend: OK / FAIL
  deactivate guard
  note right: ~10ms
end group

alt SQL unsicher
  backend -->> frontend: ‚ùå Injection detected
  frontend ->> user: ‚ùå Anfrage abgelehnt
  
else SQL sicher
  group Layer 2: LLM Semantic Validation
    backend ->> openai: Semantic Check
    activate openai
    note right
      Pr√ºft:
      - SQL passt zu Frage?
      - JOINs korrekt?
      - Logik plausibel?
    end note
    openai -->> backend: OK / FAIL + Confidence
    deactivate openai
    note right: 1-2s
  end group
  
  alt Semantik OK
    
    == ‚ö° PHASE 5: Query Execution ==
    
    group SQL-Ausf√ºhrung [SQLite]
      backend ->> db: Execute SQL
      activate db
      note right: LIMIT 100 OFFSET 0
      db -->> backend: Results [{...}, {...}]
      deactivate db
      note right: 500ms - 10s
    end group
    
    group Layer 3: Result Caching
      backend ->> cache: Cache Results
      activate cache
      cache -->> backend: ‚úì Cached
      deactivate cache
      note right: TTL: 5min
    end group
    
    == üìù PHASE 6: Summarization (Optional) ==
    
    group Nat√ºrlichsprachliche Zusammenfassung
      backend ->> llm: Summarize Results
      activate llm
      llm ->> openai: "Fasse Ergebnisse zusammen"
      openai -->> llm: summary_text
      llm -->> backend: ‚úì Summary
      deactivate llm
      note right: 1-2s
    end group
    
  else Semantik FAIL
    backend -->> frontend: ‚ö†Ô∏è Low Confidence
    note right: Self-Correction Loop m√∂glich
  end
end

deactivate backend

== ‚úÖ Response ==

backend -->> frontend: QueryResponse
note right
  <b>Response enth√§lt:</b>
  ‚Ä¢ generated_sql
  ‚Ä¢ results (Rows)
  ‚Ä¢ summary (NL-Text)
  ‚Ä¢ pagination (page, total)
  ‚Ä¢ metrics (latency, confidence)
end note

activate frontend
frontend ->> user: ‚úÖ Ergebnisse anzeigen
deactivate frontend

note over user
  <b>Performance-Metriken:</b>
  ‚Ä¢ Cache-Hit (95%): 45ms
  ‚Ä¢ Cache-Miss (5%): 6.2s
  ‚Ä¢ Durchschnitt: ~500ms
end note

legend right
  <b>6-Phasen-√úbersicht:</b>
  
  <b>Phase 1:</b> Context Loading (10-500ms)
  <b>Phase 2:</b> Ambiguity Detection (~500ms)
  <b>Phase 3:</b> SQL Generation (2-4s)
  <b>Phase 4:</b> Validation (1-2s)
  <b>Phase 5:</b> Execution (0.5-10s)
  <b>Phase 6:</b> Summarization (1-2s, optional)
  
  <b>Gesamt:</b> 45ms (cached) bis 6.2s (uncached)
end legend

@enduml