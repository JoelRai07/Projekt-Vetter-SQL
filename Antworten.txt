SELECT expemplref AS customer_id, totassets, totliabs, totassets - totliabs AS computed_networth, RANK() OVER (ORDER BY ( totassets - totliabs ) DESC NULLS FIRST) AS networth_rank FROM expenses_and_assets ORDER BY computed_networth DESC NULLS FIRST LIMIT 10
SELECT bankexpref FROM bank_and_transactions WHERE ( chaninvdatablock ->> '$.onlineuse' = 'High' OR chaninvdatablock ->> '$.mobileuse' = 'High' ) AND chaninvdatablock ->> '$.autopay' = 'Yes'
WITH investment_customers AS ( SELECT ea.expemplref AS customer_id, ea.investamt, ea.totassets, bt.chaninvdatablock -> '$.invcluster' ->> '$.investport' AS investport, bt.chaninvdatablock -> '$.invcluster' ->> '$.investexp' AS investexp FROM expenses_and_assets AS ea JOIN bank_and_transactions AS bt ON ea.expemplref = bt.bankexpref ) SELECT customer_id, investamt, totassets FROM investment_customers WHERE ( investport = 'Moderate' OR investport = 'Aggressive' ) AND investexp = 'Extensive' AND investamt > 0.3 * totassets
SELECT CASE WHEN credscore BETWEEN 300 AND 579 THEN 'Poor' WHEN credscore BETWEEN 580 AND 669 THEN 'Fair' WHEN credscore BETWEEN 670 AND 739 THEN 'Good' WHEN credscore BETWEEN 740 AND 799 THEN 'Very Good' WHEN credscore BETWEEN 800 AND 850 THEN 'Excellent' ELSE 'Unknown' END AS credit_category, COUNT(*) AS customer_count, ROUND(AVG(credscore), 2) AS average_credscore FROM credit_and_compliance GROUP BY credit_category
WITH ltv_calc AS ( SELECT expemplref, CAST(( propfinancialdata ->> '$.propvalue' ) AS REAL) AS prop_value, CAST(( propfinancialdata -> '$.mortgagebits' ->> '$.mortbalance' ) AS REAL) AS mort_balance, CASE WHEN CAST(( propfinancialdata ->> '$.propvalue' ) AS REAL) > 0 THEN ( CAST(( propfinancialdata -> '$.mortgagebits' ->> '$.mortbalance' ) AS REAL) / CAST(( propfinancialdata ->> '$.propvalue' ) AS REAL) ) ELSE NULL END AS ltv_ratio FROM expenses_and_assets WHERE NOT propfinancialdata IS NULL ) SELECT expemplref AS customer_id, prop_value, mort_balance, ROUND(ltv_ratio, 3) AS ltv_ratio FROM ltv_calc WHERE NOT ltv_ratio IS NULL ORDER BY ltv_ratio DESC NULLS FIRST
SELECT cr.clientref, ea.totassets - ea.totliabs AS net_worth, 1 AS FSI FROM core_record AS cr INNER JOIN employment_and_income AS ei ON cr.coreregistry = ei.emplcoreref INNER JOIN expenses_and_assets AS ea ON ei.emplcoreref = ea.expemplref
WITH digital_cohorts AS ( SELECT cr.clientref, strftime('%Y-%m-%d %H:%M:%S', cr.scoredate, '-' || cr.tenureyrs || ' years', 'start of quarter') AS cohort_quarter, (json_extract(bt.chaninvdatablock, '$.onlineuse') = 'High' OR json_extract(bt.chaninvdatablock, '$.mobileuse') = 'High') AND json_extract(bt.chaninvdatablock, '$.autopay') = 'Yes' AS is_digital_first, 0.4 * cah.produsescore + 0.3 * cah.chanusescore + 0.2 * bt.bankrelscore + 0.1 * (cah.custservint*1.0/10) AS ces FROM core_record cr JOIN credit_accounts_and_history cah ON cr.coreregistry = cah.histcompref JOIN bank_and_transactions bt ON cah.histcompref = bt.bankexpref WHERE bt.chaninvdatablock IS NOT NULL ) SELECT cohort_quarter, is_digital_first, COUNT(*) AS cohort_size, AVG(ces) AS avg_ces, CAST(SUM(CASE WHEN ces > 0.7 THEN 1 ELSE 0 END) AS REAL) / COUNT(*) AS pct_high_engagement, CAST(SUM(CASE WHEN is_digital_first AND ces > 0.7 THEN 1 ELSE 0 END) AS REAL) / CASE WHEN SUM(CASE WHEN is_digital_first THEN 1 ELSE 0 END) = 0 THEN NULL ELSE SUM(CASE WHEN is_digital_first THEN 1 ELSE 0 END) END AS digital_first_high_engagement_rate FROM digital_cohorts GROUP BY cohort_quarter, is_digital_first ORDER BY cohort_quarter, is_digital_first DESC;
WITH segment_stats AS ( SELECT cr.clientseg AS customer_segment, COUNT(*) AS customer_count, AVG(ea.debincratio) AS avg_dti, AVG(ea.debincratio + CASE WHEN json_extract(ex.propfinancialdata, '$.propown') = 'Own' THEN (COALESCE(CAST(json_extract(ex.propfinancialdata, '$.mortgagebits.mortbalance') AS REAL), 0)/12) / ea.mthincome WHEN json_extract(ex.propfinancialdata, '$.propown') = 'Rent' THEN (COALESCE(CAST(json_extract(ex.propfinancialdata, '$.rentpayment') AS REAL), 0)) / ea.mthincome ELSE 0 END) AS avg_tdsr FROM core_record cr JOIN employment_and_income ea ON cr.coreregistry = ea.emplcoreref LEFT JOIN expenses_and_assets ex ON ea.emplcoreref = ex.expemplref GROUP BY cr.clientseg HAVING COUNT(*) > 10 ), median_calc AS ( SELECT cr.clientseg, ea.debincratio, ROW_NUMBER() OVER (PARTITION BY cr.clientseg ORDER BY ea.debincratio) as rn, COUNT(*) OVER (PARTITION BY cr.clientseg) as total_count FROM core_record cr JOIN employment_and_income ea ON cr.coreregistry = ea.emplcoreref LEFT JOIN expenses_and_assets ex ON ea.emplcoreref = ex.expemplref WHERE cr.clientseg IN (SELECT customer_segment FROM segment_stats) ), median_dti AS ( SELECT clientseg, AVG(debincratio) AS median_dti FROM median_calc WHERE rn IN ((total_count + 1) / 2, (total_count + 2) / 2) GROUP BY clientseg ), all_segments_stats AS ( SELECT 'All Segments' AS customer_segment, COUNT(*) AS customer_count, AVG(ea.debincratio) AS avg_dti, AVG(ea.debincratio + CASE WHEN json_extract(ex.propfinancialdata, '$.propown') = 'Own' THEN (COALESCE(CAST(json_extract(ex.propfinancialdata, '$.mortgagebits.mortbalance') AS REAL), 0)/12) / ea.mthincome WHEN json_extract(ex.propfinancialdata, '$.propown') = 'Rent' THEN (COALESCE(CAST(json_extract(ex.propfinancialdata, '$.rentpayment') AS REAL), 0)) / ea.mthincome ELSE 0 END) AS avg_tdsr FROM core_record cr JOIN employment_and_income ea ON cr.coreregistry = ea.emplcoreref LEFT JOIN expenses_and_assets ex ON ea.emplcoreref = ex.expemplref WHERE cr.clientseg IN (SELECT customer_segment FROM segment_stats) ), all_segments_median AS ( SELECT AVG(debincratio) AS median_dti FROM ( SELECT ea.debincratio, ROW_NUMBER() OVER (ORDER BY ea.debincratio) as rn, COUNT(*) OVER () as total_count FROM core_record cr JOIN employment_and_income ea ON cr.coreregistry = ea.emplcoreref LEFT JOIN expenses_and_assets ex ON ea.emplcoreref = ex.expemplref WHERE cr.clientseg IN (SELECT customer_segment FROM segment_stats) ) ranked WHERE rn IN ((total_count + 1) / 2, (total_count + 2) / 2) ) SELECT ss.customer_segment, ss.customer_count, ss.avg_dti, ss.avg_tdsr, md.median_dti FROM segment_stats ss JOIN median_dti md ON ss.customer_segment = md.clientseg UNION ALL SELECT ass.customer_segment, ass.customer_count, ass.avg_dti, ass.avg_tdsr, asm.median_dti FROM all_segments_stats ass CROSS JOIN all_segments_median asm ORDER BY avg_tdsr DESC;
SELECT ei.emplcoreref AS clientref, ea.liqassets, ea.totassets, ( ea.liqassets / NULLIF(ea.totassets, 0) ) AS ALR, ei.mthincome, ea.investamt, CASE WHEN ( ea.liqassets / NULLIF(ea.totassets, 0) ) > 0.3 AND ei.mthincome > 5000 THEN 'Target' ELSE 'Standard' END AS target_status FROM employment_and_income AS ei INNER JOIN expenses_and_assets AS ea ON ei.emplcoreref = ea.expemplref
WITH stress AS ( SELECT cr.clientref, ei.debincratio, ea.liqassets, ea.totassets, ea.totliabs, ei.mthincome, cc.delinqcount, cc.latepaycount, 0.5 * ei.debincratio + 0.5 * ( 1 - ( ea.liqassets / NULLIF(ei.mthincome * 6, 0) ) ) AS FVS, ( ea.totassets - ea.totliabs ) AS net_worth FROM core_record AS cr INNER JOIN employment_and_income AS ei ON cr.coreregistry = ei.emplcoreref INNER JOIN expenses_and_assets AS ea ON ei.emplcoreref = ea.expemplref INNER JOIN credit_and_compliance AS cc ON cc.compbankref = ei.emplcoreref ) SELECT clientref, FVS, net_worth, delinqcount, latepaycount FROM stress WHERE FVS > 0.7 AND ( delinqcount > 0 OR latepaycount > 0 ) AND net_worth < 0