# BUSINESS SEMANTICS LAYER (BSL)

## Purpose
This BSL defines **business meaning** (terms, metrics, segments, and interpretation rules) for the Credit domain.
It is written to be **LLM-friendly** and to support consistent analytics across tools (Text2SQL, BI, reporting).

## Scope
- Business concepts (e.g., *customer*, *net worth*, *high engagement*, *investment focused*).
- Business rules and thresholds used to interpret data.
- Metric definitions (formulas) at the conceptual level.

## Non-goals (out of scope for the BSL itself)
- SQL dialect details (casting, placeholder syntax, JSON functions).
- Query optimization, join order tuning, engine limitations.

> Note: Implementation specifics appear in **Annex C: SQL Generation Policy** and are **not part of the BSL**.

## Glossary (Canonical Business Terms)

- **Customer**: A person/entity represented by one record across the domain tables.
- **Customer ID (business)**: The identifier used in outputs and reports (see Mapping section for source).
- **Registry ID (technical)**: The internal identifier used to relate records across tables (see Mapping section).

### Metrics (Canonical Names)
- **Debt-to-Income Ratio (DTI)**: Calculates the proportion of a customer's monthly income that goes toward debt payments.
- **Credit Utilization Ratio (CUR)**: Measures how much of available credit a customer is currently using.
- **Loan-to-Value Ratio (LTV)**: Calculates the ratio of loan amount to the value of the asset securing the loan.
- **Customer Lifetime Value (CLV)**: Measures the total worth of a customer to the financial institution over the entire relationship.
- **Net Worth**: Calculates the financial value of a customer by subtracting liabilities from assets.
- **Credit Health Score (CHS)**: Composite score measuring overall credit wellness based on multiple factors.
- **Financial Stability Index (FSI)**: Measures a customer's overall financial stability combining income, savings, and debt factors.
- **Customer Engagement Score (CES)**: Quantifies how actively a customer uses bank products and services.
- **Risk-Adjusted Return (RAR)**: Measures the profitability of a customer relationship adjusted for credit risk.
- **Account Health Index (AHI)**: Composite measure of account quality considering age, mix, and payment history.
- **Total Debt Service Ratio (TDSR)**: Extended debt ratio that accounts for all financial obligations including housing costs.
- **Credit Quality Index (CQI)**: Comprehensive measure of overall credit quality incorporating credit score and utilization.
- **Housing Affordability Ratio (HAR)**: Measures the affordability of housing costs relative to income.
- **Financial Vulnerability Score (FVS)**: Quantifies financial fragility by combining debt burden and savings adequacy.
- **Customer Retention Risk (CRR)**: Calculates risk of customer attrition based on engagement and satisfaction metrics.
- **Asset Liquidity Ratio (ALR)**: Measures the proportion of customer assets that can be quickly converted to cash.
- **Credit Risk Intensity (CRI)**: Advanced measure of credit risk that incorporates payment history and account diversity.
- **Investment Portfolio Quality (IPQ)**: Evaluates the quality and performance of customer's investment allocations.
- **Banking Relationship Strength (BRS)**: Quantifies the depth and quality of a customer's banking relationship.
- **Credit Health Momentum (CHM)**: Measures the trajectory of a customer's credit health over time.

### Segments / Classifications
- **Prime Customer**: Segment defined by business rules (see section below).
- **Financially Vulnerable**: Segment defined by business rules (see section below).
- **High-Value Customer**: Segment defined by business rules (see section below).
- **Credit Builder**: Segment defined by business rules (see section below).
- **Digital First Customer**: Segment defined by business rules (see section below).
- **Investment Focused**: Segment defined by business rules (see section below).
- **Revolving Credit Dependent**: Segment defined by business rules (see section below).
- **Property Risk Exposure**: Segment defined by business rules (see section below).
- **Frequent Credit Seeker**: Segment defined by business rules (see section below).
- **Over-Extended**: Segment defined by business rules (see section below).
- **Mortgage Risk Profile**: Segment defined by business rules (see section below).
- **Credit Utilization Alert**: Segment defined by business rules (see section below).
- **Financial Stress Indicator**: Segment defined by business rules (see section below).
- **Premium Banking Candidate**: Segment defined by business rules (see section below).
- **Digital Channel Opportunity**: Segment defined by business rules (see section below).
- **Credit Building Opportunity**: Segment defined by business rules (see section below).
- **Investment Services Target**: Segment defined by business rules (see section below).
- **Declining Credit Health**: Segment defined by business rules (see section below).
- **Relationship Attrition Risk**: Segment defined by business rules (see section below).
- **Cross-Sell Priority**: Segment defined by business rules (see section below).
- **High Engagement Criteria**: Segment defined by business rules (see section below).
- **Cohort Quarter**: Segment defined by business rules (see section below).


## Business Rules

### Customer Segmentation
Segments are defined **by business conditions** on metrics and attributes. They must be interpreted consistently.

#### Prime Customer
A customer with credscore > 720, defhist of 'Excellent' or 'Good', and risklev of 'Low'.

#### Financially Vulnerable
A customer with debincratio > 0.5, liqassets < mthincome × 3, and at least one of: delinqcount > 0, latepaycount > 1, or ovrfreq of 'Frequent'.

#### High-Value Customer
A customer with custlifeval in the top quartile, tenureyrs > 5, and crossratio > 0.5.

#### Credit Builder
A customer with credageyrs < 3, credinq > 2 in the past year, and recentbeh of 'Improving'.

#### Digital First Customer
A customer with chaninvdatablock.onlineuse of 'High' or chaninvdatablock.mobileuse of 'High', and chaninvdatablock.autopay of 'Yes'.

#### Investment Focused
A customer with chaninvdatablock.invcluster.investport of 'Moderate' or 'Aggressive', chaninvdatablock.invcluster.investexp of 'Extensive', and investamt > 0.3 × totassets.

#### Revolving Credit Dependent
A customer with credutil > 0.7, cardcount > 2, and cardpayhist of 'Fair' or 'Poor'.

#### Property Risk Exposure
A customer with propfinancialdata.propown of 'Own', LTV > 0.8, and propfinancialdata.mortgagebits.mortpayhist of 'Fair' or 'Poor'.

#### Frequent Credit Seeker
A customer with hardinq > 3 in the past six months, seekbeh of 'High', and newaccage < 1.

#### Over-Extended
A customer with DTI > 0.43, CUR > 0.8, and at least one of: ovrfreq of 'Frequent', bouncecount > 0 in the past three months.

#### Mortgage Risk Profile
A customer with high LTV (Loan-to-Value Ratio > 0.9), negative equity risk (LTV > 1.0), or payment stress (propfinancialdata.mortgagebits.mortpayhist of 'Fair' or 'Poor').

#### Credit Utilization Alert
A customer with CUR (Credit Utilization Ratio) > 0.8, an increasing trend in utilization, and limited available credit (totcredlimit < mthincome × 2).

#### Financial Stress Indicator
A customer with FVS (Financial Vulnerability Score) > 0.7, recent payment issues (delinqcount > 0 or latepaycount > 0 in past six months), and negative Net Worth.

#### Premium Banking Candidate
A customer with high CQI (Credit Quality Index > 0.8), strong FSI (Financial Stability Index > 0.7), and significant assets (totassets > $250,000).

#### Digital Channel Opportunity
A customer with low digital engagement (chaninvdatablock.onlineuse not 'High' and chaninvdatablock.mobileuse not 'High') but high BRS (Banking Relationship Strength > 0.7) and multiple products (produsescore > 0.5).

#### Credit Building Opportunity
A customer with limited credit history (credageyrs < 2), low CQI (Credit Quality Index < 0.6), but positive banking behavior (bouncecount = 0 and bankrelscore > 0.6).

#### Investment Services Target
A customer with high ALR (Asset Liquidity Ratio > 0.3) and strong income (mthincome > $5,000).

#### Declining Credit Health
A customer with negative CHM (Credit Health Momentum < 0), increasing CRI (Credit Risk Intensity growing by >10% in 6 months), and rising DTI (Debt-to-Income Ratio increasing by >5% in 6 months).

#### Relationship Attrition Risk
A customer with high CRR (Customer Retention Risk > 0.7), declining product usage (decreasing produsescore), and competitive shopping behavior (hardinq > 2 in past 3 months).

#### Cross-Sell Priority
A customer with strong CES (Customer Engagement Score > 0.7), positive CQI (Credit Quality Index > 0.7), and unrealized product potential (crossratio > 0.5 but produsescore < 0.5).

#### High Engagement Criteria
A Customer Engagement Score (CES) greater than 0.7.

#### Cohort Quarter
Quarter of the year when the customer started with the institution (scoring date minus tenure years)

### Value Interpretation Guidelines
- **Credit Score Categories**: Credit scores (credscore) typically range from 300-850. 300-579: Poor, 580-669: Fair, 670-739: Good, 740-799: Very Good, 800-850: Excellent, Otherwise: Unknown. Higher scores indicate lower credit risk.
- **Income Stability Score**: Income stability (incstabscore) ranges from 0-10. Scores below 3 indicate highly variable income, 3-6 indicates moderate stability, and above 6 indicates highly stable income sources.
- **Debt-to-Income Ratio Interpretation**: Debt-to-Income ratio (debincratio) ranges from 0-1 (or above). Below 0.36 is typically considered excellent, 0.36-0.43 is good, 0.43-0.50 is concerning, and above 0.50 is risky for new credit approval.
- **Credit Utilization Impact**: Credit Utilization (credutil) ranges from 0-1 (or above). Utilization under 0.30 is optimal for credit scores, 0.30-0.50 has moderate negative impact, 0.50-0.70 has significant negative impact, and above 0.70 severely impacts credit scores.
- **Loan-to-Value Ratio Significance**: Loan-to-Value ratio (LTV) typically ranges from 0-1 (or above). Below 0.80 generally avoids private mortgage insurance requirements, 0.80-0.95 typically requires PMI, and above 0.95 indicates high leverage and increased lending risk.
- **Risk Level Classifications**: Risk level (risklev) values indicate likelihood of default or financial difficulty. 'Low' indicates minimal risk, 'Medium' indicates moderate risk requiring standard monitoring, 'High' indicates significant risk requiring enhanced monitoring, and 'Very High' indicates severe r...
- **Payment History Quality**: Payment history (defhist, mortpayhist, rentpayhist, cardpayhist, loanpayhist) classifications indicate reliability. 'Excellent' indicates no late payments, 'Good' indicates minimal late payments, 'Fair' indicates occasional missed payments, 'Poor' indicates regular missed paym...
- **Cross-Sell Ratio Meaning**: Cross-sell ratio (crossratio) ranges from 0-1. Values below 0.2 indicate minimal product relationships, 0.2-0.5 indicates moderate opportunity, and above 0.5 indicates strong existing relationship with high additional sales potential.
- **Account Mix Score Interpretation**: Account mix score (accmixscore) ranges from 0-1. Higher scores indicate a healthy diversity of account types (revolving, installment, mortgage, etc.), which positively impacts credit scores and indicates financial sophistication.
- **Churn Rate Significance**: Churn rate (churnrate) ranges from 0-1. Values below 0.1 indicate low attrition risk, 0.1-0.2 indicates moderate risk, 0.2-0.3 indicates high risk, and above 0.3 indicates severe risk of customer loss requiring immediate relationship management intervention.


## Metric Definitions (Conceptual)

When a question references a metric name, interpret it using these definitions.
Formulas are expressed conceptually; implementation details may vary by SQL dialect.

### Debt-to-Income Ratio (DTI)
- **Meaning:** Calculates the proportion of a customer's monthly income that goes toward debt payments.
- **Definition / Formula:** DTI = \frac{\text{Total Monthly Debt Payments}}{\text{Monthly Income}} = debincratio

### Credit Utilization Ratio (CUR)
- **Meaning:** Measures how much of available credit a customer is currently using.
- **Definition / Formula:** CUR = \frac{\text{Total Credit Used}}{\text{Total Credit Limit}} = credutil

### Loan-to-Value Ratio (LTV)
- **Meaning:** Calculates the ratio of loan amount to the value of the asset securing the loan.
- **Definition / Formula:** LTV = \frac{\text{Mortgage Balance}}{\text{Property Value}} = \frac{\text{propfinancialdata.mortgagebits.mortbalance}}{\text{propfinancialdata.propvalue}}

### Customer Lifetime Value (CLV)
- **Meaning:** Measures the total worth of a customer to the financial institution over the entire relationship.
- **Definition / Formula:** CLV = custlifeval, which factors in product usage, tenure, profitability, and expected future transactions.

### Net Worth
- **Meaning:** Calculates the financial value of a customer by subtracting liabilities from assets.
- **Definition / Formula:** Net Worth = \text{Total Assets} - \text{Total Liabilities} = totassets - totliabs = networth

### Credit Health Score (CHS)
- **Meaning:** Composite score measuring overall credit wellness based on multiple factors.
- **Definition / Formula:** CHS = 0.4 × \frac{credscore}{850} + 0.2 × (1 - credutil) + 0.2 × (1 - debincratio) + 0.1 × \frac{credageyrs}{20} + 0.1 × (1 - \frac{delinqcount + latepaycount + choffs + bankr}{10}), \text{where each component is capped at 1.0}

### Financial Stability Index (FSI)
- **Meaning:** Measures a customer's overall financial stability combining income, savings, and debt factors.
- **Definition / Formula:** FSI = 0.3 × (1 - debincratio) + 0.3 × \frac{liqassets}{mthincome × 6} + 0.2 × \frac{bankaccbal}{mthincome × 3} + 0.2 × \frac{savamount}{mthincome × 12}, \text{where each component is capped at 1.0}

### Customer Engagement Score (CES)
- **Meaning:** Quantifies how actively a customer uses bank products and services.
- **Definition / Formula:** CES = 0.4 × produsescore + 0.3 × chanusescore + 0.2 × bankrelscore + 0.1 × \frac{custservint}{10}, \text{where each component is capped at 1.0}

### Risk-Adjusted Return (RAR)
- **Meaning:** Measures the profitability of a customer relationship adjusted for credit risk.
- **Definition / Formula:** RAR = profitscore × (1 - \frac{risklev}{4}), \text{where risklev is converted to a numeric scale: Low=1, Medium=2, High=3, Very High=4}

### Account Health Index (AHI)
- **Meaning:** Composite measure of account quality considering age, mix, and payment history.
- **Definition / Formula:** AHI = 0.4 × \frac{avgaccage}{10} + 0.3 × accmixscore + 0.3 × payconsist, \text{where each component is capped at 1.0}

### Total Debt Service Ratio (TDSR)
- **Meaning:** Extended debt ratio that accounts for all financial obligations including housing costs.
- **Definition / Formula:** TDSR = DTI + \frac{\text{Housing Costs}}{\text{Monthly Income}}, \text{where Housing Costs are determined by propfinancialdata and DTI is the Debt-to-Income Ratio}

### Credit Quality Index (CQI)
- **Meaning:** Comprehensive measure of overall credit quality incorporating credit score and utilization.
- **Definition / Formula:** CQI = 0.6 × \frac{credscore}{850} + 0.4 × (1 - CUR), \text{where CUR is the Credit Utilization Ratio}

### Housing Affordability Ratio (HAR)
- **Meaning:** Measures the affordability of housing costs relative to income.
- **Definition / Formula:** HAR = \frac{\text{Monthly Housing Payment}}{\text{Monthly Income}} × 100\%, \text{where Monthly Housing Payment is derived from propfinancialdata and LTV calculations}

### Financial Vulnerability Score (FVS)
- **Meaning:** Quantifies financial fragility by combining debt burden and savings adequacy.
- **Definition / Formula:** FVS = 0.5 × DTI + 0.5 × (1 - \frac{liqassets}{mthincome × 6}), \text{where DTI is the Debt-to-Income Ratio and the second term measures emergency fund adequacy}

### Customer Retention Risk (CRR)
- **Meaning:** Calculates risk of customer attrition based on engagement and satisfaction metrics.
- **Definition / Formula:** CRR = 0.4 × churnrate + 0.3 × (1 - CES) + 0.3 × \frac{complainthist}{3}, \text{where CES is the Customer Engagement Score and complainthist is converted to numeric (Low=1, Medium=2, High=3)}

### Asset Liquidity Ratio (ALR)
- **Meaning:** Measures the proportion of customer assets that can be quickly converted to cash.
- **Definition / Formula:** ALR = \frac{liqassets}{totassets} = \frac{liqassets}{Net Worth + totliabs}, \text{where Net Worth is the difference between assets and liabilities}

### Credit Risk Intensity (CRI)
- **Meaning:** Advanced measure of credit risk that incorporates payment history and account diversity.
- **Definition / Formula:** CRI = 0.5 × (1 - \frac{credscore}{850}) + 0.3 × \frac{delinqcount + latepaycount + choffs}{10} + 0.2 × (1 - AHI), \text{where AHI is the Account Health Index}

### Investment Portfolio Quality (IPQ)
- **Meaning:** Evaluates the quality and performance of customer's investment allocations.
- **Definition / Formula:** IPQ = 0.4 × RAR + 0.4 × \frac{investamt}{totassets} + 0.2 × \frac{chaninvdatablock.invcluster.investexp}{3}, \text{where RAR is the Risk-Adjusted Return and investexp is converted to numeric (Limited=1, Moderate=2, Extensive=3)}

### Banking Relationship Strength (BRS)
- **Meaning:** Quantifies the depth and quality of a customer's banking relationship.
- **Definition / Formula:** BRS = 0.3 × bankrelscore + 0.3 × (1 - churnrate) + 0.4 × CES, \text{where CES is the Customer Engagement Score}

### Credit Health Momentum (CHM)
- **Meaning:** Measures the trajectory of a customer's credit health over time.
- **Definition / Formula:** CHM = CHS × (1 + \Delta_\text{recentbeh}), \text{where CHS is the Credit Health Score and } \Delta_\text{recentbeh} \text{ is +0.1 for 'Improving', 0 for 'Stable', and -0.1 for 'Deteriorating'}


---

# SEMANTIC-TO-SCHEMA MAPPING (NOT PART OF THE BSL)

## Identifier Mapping (Critical)

This domain uses **two identifiers for the same customer**:

### Customer ID (business output identifier)
- **Semantic meaning:** what business users mean by "customer id" in reports
- **Source column:** `core_record.coreregistry`
- **Format:** `CS` + digits (e.g., `CS206405`)

### Client Reference (alternative identifier)
- **Semantic meaning:** alternative client reference number
- **Source column:** `core_record.clientref`
- **Format:** `CU` + digits (e.g., `CU338528`)

### Invariants (must always hold)
- A single customer has **both** identifiers, but they are **not equal** and must never be compared for equality.
- **CRITICAL: Business outputs MUST ALWAYS use Customer ID (CS format) from core_record.coreregistry as the customer_id.**
- Use Client Reference (CU format) ONLY when the question explicitly asks for "client reference" or "clientref".
- Data relationships across tables are expressed using the **Registry ID chain** (see relationship chain below).


## Entity Relationship Chain (Conceptual)

The data model forms a strict customer-centric chain:

- **Core Record** → **Employment & Income** → **Expenses & Assets** → **Bank & Transactions** → **Credit & Compliance** → **Credit Accounts & History**

### Why this matters
- Many business questions combine metrics from multiple domain areas.
- Correct answers require respecting the relationship chain; skipping intermediate entities can break meaning and integrity.


## Semi-Structured Fields (JSON stored in a column)

Some columns contain JSON documents (often stored as TEXT in the schema).
Interpret these fields using the paths below.

### expenses_and_assets.propfinancialdata (declared type: `TEXT`)
JSONB column. Bundles all housing‑related facts (ownership, value, and pay history) so risk or marketing rules need only one JSONB lookup.

**Paths:**
- `propown`: An enum (PropertyOwnership_enum) describing property ownership (Rent, Living with Parents, Own).
- `proptype`: An enum (PropertyType_enum) for property classification (Apartment, House, Condo).
- `propvalue`: A DECIMAL(15,2) property value (e.g., '250000.00').
- `mortgagebits` (object):
  - `mortgagebits.mortbalance`: A DECIMAL(15,2) storing current mortgage balance (e.g., '150000.00').
  - `mortgagebits.mortpayhist`: An enum (PaymentHistory_enum) for mortgage payment history. Possible values: Poor, Fair, Good, Excellent, Current, Past.
- `rentpayhist`: An enum (PaymentHistory_enum) for rent payment history. Possible values: Poor, Fair, Good, Excellent, Current, Past.

### bank_and_transactions.chaninvdatablock (declared type: `TEXT`)
JSONB column. Packs together digital‑channel habits and investment/trading style flags for engagement and cross‑sell scoring.

**Paths:**
- `onlineuse`: An enum (OnlineBankingUsage_enum) describing online banking use (High, Medium, Low).
- `mobileuse`: An enum (MobileBankingUsage_enum) describing mobile banking usage (High, Medium, Low).
- `autopay`: An enum (YesNo_enum) indicating if automatic payments are active (Yes, No).
- `depostat`: An enum (YesNo_enum) indicating direct deposit usage (Yes, No).
- `invcluster` (object):
  - `invcluster.investport`: An enum (InvestmentPortfolio_enum) labeling investment portfolio style (Conservative, Moderate, Aggressive).
  - `invcluster.investexp`: An enum (InvestmentExperience_enum) capturing investing experience (Extensive, Moderate, Limited).
  - `invcluster.tradeact`: An enum (TradingActivity_enum) describing trading activity (High, Medium, Low).


---

# ANNEX C: SQL GENERATION POLICY (IMPLEMENTATION NOTES)

## Aggregation vs Detail Decision Rules

### Aggregation questions (GROUP BY)
Trigger words: 'by category', 'by segment', 'for each', 'breakdown', 'summary', 'cohorts', 'how many', 'count', 'average', 'total'.

### Ranking/listing (ORDER BY + LIMIT)
Trigger words: 'top N', 'highest', 'lowest', 'best', 'worst'.

### Row-level detail (no aggregation)
Trigger words: 'show all', 'list each', 'identify', 'find customers where'.

### Policy Overrides (Credit DB)
- "digital native" → treat as **Digital First Customer** segment.
- "credit classification" → treat as **credit score categories** (credscore bands).
- If a question says "few customers" without a threshold: default to `HAVING COUNT(*) >= 10` (policy choice).
- "investment potential" label → use 'Target' for customers with ALR > 0.3 AND mthincome > 5000, otherwise 'Standard'.
- Percentage metrics (e.g., pct_high_engagement) → always express as decimal ratio 0-1 (e.g., 0.1684), never multiply by 100.

## Reminder: Frequently Used Metrics
- Debt-to-Income Ratio (DTI): DTI = \frac{\text{Total Monthly Debt Payments}}{\text{Monthly Income}} = debincratio
- Credit Utilization Ratio (CUR): CUR = \frac{\text{Total Credit Used}}{\text{Total Credit Limit}} = credutil
- Loan-to-Value Ratio (LTV): LTV = \frac{\text{Mortgage Balance}}{\text{Property Value}} = \frac{\text{propfinancialdata.mortgagebits.mortbalance}...
- Customer Lifetime Value (CLV): CLV = custlifeval, which factors in product usage, tenure, profitability, and expected future transactions.
- Net Worth: Net Worth = \text{Total Assets} - \text{Total Liabilities} = totassets - totliabs = networth
- Credit Health Score (CHS): CHS = 0.4 × \frac{credscore}{850} + 0.2 × (1 - credutil) + 0.2 × (1 - debincratio) + 0.1 × \frac{credageyrs}{20} + 0....
- Financial Stability Index (FSI): FSI = 0.3 × (1 - debincratio) + 0.3 × \frac{liqassets}{mthincome × 6} + 0.2 × \frac{bankaccbal}{mthincome × 3} + 0.2...
- Customer Engagement Score (CES): CES = 0.4 × produsescore + 0.3 × chanusescore + 0.2 × bankrelscore + 0.1 × \frac{custservint}{10}, \text{where each c...
