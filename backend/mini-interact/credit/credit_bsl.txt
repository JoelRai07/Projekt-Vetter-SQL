# BUSINESS SEMANTICS LAYER (BSL)
# Credit Database - Text2SQL Knowledge Base

This document contains explicit business rules and patterns for generating correct SQL.
It was auto-generated from the knowledge base and schema.

---

# IDENTITY SYSTEM RULES (CRITICAL)

## ⚠️ CRITICAL: Dual Identifier System
This database uses TWO DIFFERENT identifiers per customer:

### CU Format (Customer ID)
- Format: CU followed by digits (e.g., CU456680, CU582141)
- Source: `core_record.clientref`
- Purpose: Business identifier, used in output/reports
- When to use: Question asks for 'customer ID', 'customer identifier', or 'show customer'

### CS Format (Core Registry ID)
- Format: CS followed by digits (e.g., CS239090, CS206405)
- Source: `core_record.coreregistry` (PRIMARY KEY)
- Purpose: Technical identifier, used for JOINs and internal references
- When to use: Joining tables, filtering by registry, or technical lookups

## ⚠️ RULE 1: SAME PERSON, DIFFERENT IDs
Both refer to the SAME person but are INCOMPATIBLE in queries:
- DO NOT SELECT clientref AND coreregistry from same row expecting them to match
- DO NOT use CU format for WHERE clauses on coreregistry
- DO NOT use CS format in output when question asks for 'customer ID'

## ⚠️ RULE 2: Identifier Selection in SELECT
The SELECT clause determines your output identifier:

**WRONG Examples (Common Mistakes):**
```sql
SELECT coreregistry FROM core_record;  -- Returns CS format, not CU
SELECT clientref AS customer_id FROM core_record;  -- ✓ Correct, returns CU
```

**Question: 'Show top 10 wealthiest customers'**
- Output should be: CU format (e.g., CU456680)
- Correct: SELECT cr.clientref AS customer_id, ea.totassets
- WRONG: SELECT cr.coreregistry AS customer_id (returns CS format)

## ⚠️ RULE 3: Identifier Usage in JOINs
ALL joins use CS format (coreregistry):
```sql
FROM core_record cr
JOIN employment_and_income ei ON cr.coreregistry = ei.emplcoreref  -- Use CS
JOIN expenses_and_assets ea ON ei.emplcoreref = ea.expemplref      -- Use CS chain
```

## ⚠️ RULE 4: Output vs Internal Logic
When SELECT clause has:
- `cr.clientref` → Output will be CU format ✓
- `cr.coreregistry` → Output will be CS format (usually wrong for 'customer ID')
- `ei.emplcoreref` → This is CS format (for joining, NOT output)

## ⚠️ RULE 5: Question-Specific Identifier Requirements

### Question Type: Ranking/Listing (Top N, Highest, Best)
Example: 'Top 10 wealthiest customers'
- Output identifier: clientref (CU format)
- Correct SELECT: cr.clientref, ea.totassets
- Common Error: Selecting coreregistry (returns CS format)

### Question Type: Segmentation/Cohort Analysis
Example: 'Analyze by cohort quarter'
- Output identifier: clientref (CU format)
- Additional logic: May need to determine cohort_quarter from scoredate
- Correct SELECT: cr.clientref, cohort_quarter, COUNT(*)
- Common Error: Not extracting quarter correctly, wrong identifier

### Question Type: Risk/Condition Filtering
Example: 'High-risk customers (High risk level, delinquencies, negative net worth)'
- Output identifier: clientref (CU format)
- Additional columns: Risk indicators (delinqcount, risklev, net_worth)
- Correct SELECT: cr.clientref, cc.risklev, cc.delinqcount, net_worth
- Common Error: Using CS format, missing filters, wrong join chain

## ⚠️ VALIDATION CHECKLIST
Before returning SQL, verify:
1. ☐ Is question asking for 'customer ID'? → SELECT cr.clientref
2. ☐ Are all JOINs using coreregistry (CS)? → Check ON conditions
3. ☐ Does output identifier match question type? → CU for customer queries
4. ☐ If using coreregistry in SELECT, is it intentional? → Usually wrong
5. ☐ Are there different customers in results than reference? → Check identifier type

# AGGREGATION DETECTION RULES

## ⚠️ CRITICAL: Aggregation vs Detail Queries

### Aggregation Queries (Must use GROUP BY)
Keywords that REQUIRE GROUP BY:
- 'by category', 'by segment', 'for each', 'breakdown', 'summary'
- 'analyze ... by', 'group into', 'cohorts'
- 'how many', 'count', 'average', 'total'

Exception:
- If question asks for categories AND customer details, return row-level records with category (no GROUP BY).

Example: 'Analyze credit scores BY risk level'  → GROUP BY risklev

### Detail/Ranking Queries (No GROUP BY, use ORDER + LIMIT)
Keywords that require RANKING (ORDER BY + LIMIT):
- 'top N', 'highest', 'lowest', 'best', 'worst'
- 'list top', 'show best', 'find worst'

Example: 'Top 10 wealthiest customers' → ORDER BY totassets DESC LIMIT 10
⚠️ NOT GROUP BY (each customer appears once, not aggregated)

### Detail Queries (Row-level, no aggregation)
Keywords that require ROW-LEVEL output:
- 'show all', 'list each', 'find customers where', 'identify'
- 'display', 'retrieve', 'find' (without aggregation keywords)

Example: 'Find all digital-first customers' → SELECT WHERE (no GROUP BY)
⚠️ Do NOT GROUP BY unless question explicitly asks for breakdown

## ⚠️ CRITICAL: Cohort Questions (Special Case)
When question asks 'by cohort quarter' AND an explicit time range is given:
- This is a GROUPING operation
- Must create cohort_quarter variable from scoredate
- Formula: Extract quarter from scoredate (or tenure-based cohort)
- MUST include GROUP BY cohort_quarter
- Each row shows: customer (or cohort indicator), metrics
If no explicit years/quarters are given, do NOT include cohort_quarter in output.

## ⚠️ CRITICAL: Multi-Level Grouping (Advanced)
When question asks 'group by X AND ALSO Y':
Example: 'Show engagement by cohort AND by digital native status'
- GROUP BY cohort_quarter, is_digital_native
- Each row is a unique (cohort, digital_native) combination
- Use aggregate functions: COUNT(*), AVG(), SUM()

### Percentage Calculations in Grouped Data
When question asks 'percentage of the cohort with high engagement':

**WRONG (mixing aggregation levels):**
```sql
SELECT cohort_quarter,
  SUM(CASE WHEN engagement > 0.7 THEN 1 ELSE 0 END) AS high_count,
  COUNT(*) AS total
FROM base_data
GROUP BY cohort_quarter;
-- Then calculate 100 * high_count / total in application
```

**CORRECT (in SQL):**
```sql
SELECT cohort_quarter,
  COUNT(*) AS cohort_size,
  CAST(SUM(CASE WHEN engagement > 0.7 THEN 1 ELSE 0 END) AS REAL) / COUNT(*) AS pct_high_engagement
FROM base_data
GROUP BY cohort_quarter;
```

### Multiple Grouping with Percentages
When question asks for percentages at MULTIPLE aggregation levels:
Example: 'percentage of the cohort WITH high engagement' + 'high-engagement percentage BROKEN DOWN by digital native'

**This requires:**
1. First GROUP BY: cohort_quarter → compute overall cohort %
2. Second GROUP BY: cohort_quarter + digital_native → compute per-group %
3. Relate them: use JOIN or window functions

**Template:**
```sql
WITH base AS (
  SELECT cohort_quarter, is_digital_native, engagement_score
  FROM ... WHERE ...
),
cohort_totals AS (
  SELECT cohort_quarter, COUNT(*) AS total_cohort_size
  FROM base
  GROUP BY cohort_quarter
),
grouped AS (
  SELECT
    cohort_quarter,
    is_digital_native,
    COUNT(*) AS segment_size,
    AVG(engagement_score) AS avg_engagement,
    CAST(SUM(CASE WHEN engagement_score > 0.7 THEN 1 ELSE 0 END) AS REAL) / COUNT(*) AS pct_high_in_segment
  FROM base
  GROUP BY cohort_quarter, is_digital_native
)
SELECT
  g.cohort_quarter,
  g.is_digital_native,
  g.segment_size,
  g.avg_engagement,
  ct.pct_high_overall,  -- Percentage in entire cohort
  g.pct_high_in_segment  -- Percentage within this segment
FROM grouped g
JOIN cohort_totals ct ON g.cohort_quarter = ct.cohort_quarter;
```

## Special Case: Grand Total
If question asks for 'total' AND segment breakdown:
→ Use UNION ALL with aggregated segments + total row

## Calculated Metrics (may require aggregation):
- Debt-to-Income Ratio (DTI): DTI = \frac{\text{Total Monthly Debt Payments}}{\text{Monthly Income}} = debincratio...
- Credit Utilization Ratio (CUR): CUR = \frac{\text{Total Credit Used}}{\text{Total Credit Limit}} = credutil...
- Loan-to-Value Ratio (LTV): LTV = \frac{\text{Mortgage Balance}}{\text{Property Value}} = \frac{\text{propfinancialdata.mortgage...
- Customer Lifetime Value (CLV): CLV = custlifeval, which factors in product usage, tenure, profitability, and expected future transa...
- Net Worth: Net Worth = \text{Total Assets} - \text{Total Liabilities} = totassets - totliabs = networth...

# BUSINESS LOGIC RULES

## Customer Segmentation Rules:
### Prime Customer
A customer with credscore > 720, defhist of 'Excellent' or 'Good', and risklev of 'Low'.

### Financially Vulnerable
A customer with debincratio > 0.5, liqassets < mthincome × 3, and at least one of: delinqcount > 0, latepaycount > 1, or ovrfreq of 'Frequent'.

### High-Value Customer
A customer with custlifeval in the top quartile, tenureyrs > 5, and crossratio > 0.5.

### Credit Builder
A customer with credageyrs < 3, credinq > 2 in the past year, and recentbeh of 'Improving'.

### Digital First Customer
A customer with chaninvdatablock.onlineuse of 'High' or chaninvdatablock.mobileuse of 'High', and chaninvdatablock.autopay of 'Yes'.

### Investment Focused
A customer with chaninvdatablock.invcluster.investport of 'Moderate' or 'Aggressive', chaninvdatablock.invcluster.investexp of 'Extensive', and investamt > 0.3 × totassets.

### Revolving Credit Dependent
A customer with credutil > 0.7, cardcount > 2, and cardpayhist of 'Fair' or 'Poor'.

### Property Risk Exposure
A customer with propfinancialdata.propown of 'Own', LTV > 0.8, and propfinancialdata.mortgagebits.mortpayhist of 'Fair' or 'Poor'.

### Frequent Credit Seeker
A customer with hardinq > 3 in the past six months, seekbeh of 'High', and newaccage < 1.

### Over-Extended
A customer with DTI > 0.43, CUR > 0.8, and at least one of: ovrfreq of 'Frequent', bouncecount > 0 in the past three months.

### Mortgage Risk Profile
A customer with high LTV (Loan-to-Value Ratio > 0.9), negative equity risk (LTV > 1.0), or payment stress (propfinancialdata.mortgagebits.mortpayhist of 'Fair' or 'Poor').

### Credit Utilization Alert
A customer with CUR (Credit Utilization Ratio) > 0.8, an increasing trend in utilization, and limited available credit (totcredlimit < mthincome × 2).

### Financial Stress Indicator
A customer with FVS (Financial Vulnerability Score) > 0.7, recent payment issues (delinqcount > 0 or latepaycount > 0 in past six months), and negative Net Worth.

### Premium Banking Candidate
A customer with high CQI (Credit Quality Index > 0.8), strong FSI (Financial Stability Index > 0.7), and significant assets (totassets > $250,000).

### Digital Channel Opportunity
A customer with low digital engagement (chaninvdatablock.onlineuse not 'High' and chaninvdatablock.mobileuse not 'High') but high BRS (Banking Relationship Strength > 0.7) and multiple products (produsescore > 0.5).

### Credit Building Opportunity
A customer with limited credit history (credageyrs < 2), low CQI (Credit Quality Index < 0.6), but positive banking behavior (bouncecount = 0 and bankrelscore > 0.6).

### Investment Services Target
A customer with high ALR (Asset Liquidity Ratio > 0.3) and strong income (mthincome > $5,000).

### Declining Credit Health
A customer with negative CHM (Credit Health Momentum < 0), increasing CRI (Credit Risk Intensity growing by >10% in 6 months), and rising DTI (Debt-to-Income Ratio increasing by >5% in 6 months).

### Relationship Attrition Risk
A customer with high CRR (Customer Retention Risk > 0.7), declining product usage (decreasing produsescore), and competitive shopping behavior (hardinq > 2 in past 3 months).

### Cross-Sell Priority
A customer with strong CES (Customer Engagement Score > 0.7), positive CQI (Credit Quality Index > 0.7), and unrealized product potential (crossratio > 0.5 but produsescore < 0.5).

### High Engagement Criteria
A Customer Engagement Score (CES) greater than 0.7.

### Cohort Quarter
Quarter of the year when the customer started with the institution (scoring date minus tenure years)

## Value Interpretation Guidelines:
- Credit Score Categories: Credit scores (credscore) typically range from 300-850. 300-579: Poor, 580-669: Fair, 670-739: Good, 740-799: Very Good, 800-850: Excellent, Otherwise...
- Income Stability Score: Income stability (incstabscore) ranges from 0-10. Scores below 3 indicate highly variable income, 3-6 indicates moderate stability, and above 6 indica...
- Debt-to-Income Ratio Interpretation: Debt-to-Income ratio (debincratio) ranges from 0-1 (or above). Below 0.36 is typically considered excellent, 0.36-0.43 is good, 0.43-0.50 is concernin...
- Credit Utilization Impact: Credit Utilization (credutil) ranges from 0-1 (or above). Utilization under 0.30 is optimal for credit scores, 0.30-0.50 has moderate negative impact,...
- Loan-to-Value Ratio Significance: Loan-to-Value ratio (LTV) typically ranges from 0-1 (or above). Below 0.80 generally avoids private mortgage insurance requirements, 0.80-0.95 typical...

# JSON FIELD EXTRACTION RULES

## Important: JSON columns must be qualified with table name

### expenses_and_assets.propfinancialdata (JSONB)
JSONB column. Bundles all housing‑related facts (ownership, value, and pay history) so risk or marketing rules need only one JSONB lookup.

**Fields:**
- `propown`: An enum (PropertyOwnership_enum) describing property ownership (Rent, Living with Parents, Own).
- `proptype`: An enum (PropertyType_enum) for property classification (Apartment, House, Condo).
- `propvalue`: A DECIMAL(15,2) property value (e.g., '250000.00').
- `mortgagebits` (nested):
  - `mortbalance`: A DECIMAL(15,2) storing current mortgage balance (e.g., '150000.00').
  - `mortpayhist`: An enum (PaymentHistory_enum) for mortgage payment history. Possible values: Poor, Fair, Good, Excellent, Current, Past.
- `rentpayhist`: An enum (PaymentHistory_enum) for rent payment history. Possible values: Poor, Fair, Good, Excellent, Current, Past.

**Example extraction:**
```sql
json_extract(expenses_and_assets.propfinancialdata, '$.propown')
```

### bank_and_transactions.chaninvdatablock (JSONB)
JSONB column. Packs together digital‑channel habits and investment/trading style flags for engagement and cross‑sell scoring.

**Fields:**
- `onlineuse`: An enum (OnlineBankingUsage_enum) describing online banking use (High, Medium, Low).
- `mobileuse`: An enum (MobileBankingUsage_enum) describing mobile banking usage (High, Medium, Low).
- `autopay`: An enum (YesNo_enum) indicating if automatic payments are active (Yes, No).
- `depostat`: An enum (YesNo_enum) indicating direct deposit usage (Yes, No).
- `invcluster` (nested):
  - `investport`: An enum (InvestmentPortfolio_enum) labeling investment portfolio style (Conservative, Moderate, Aggressive).
  - `investexp`: An enum (InvestmentExperience_enum) capturing investing experience (Extensive, Moderate, Limited).
  - `tradeact`: An enum (TradingActivity_enum) describing trading activity (High, Medium, Low).

**Example extraction:**
```sql
json_extract(bank_and_transactions.chaninvdatablock, '$.onlineuse')
```

# JOIN CHAIN RULES (CRITICAL)

## ⚠️ RULE: Foreign Key Chain is STRICT
The data model enforces a rigid chain. NEVER skip or reorder:

```
core_record (coreregistry PRIMARY KEY)
  ↓ FK: coreregistry = emplcoreref
employment_and_income (emplcoreref PRIMARY KEY)
  ↓ FK: emplcoreref = expemplref
expenses_and_assets (expemplref PRIMARY KEY)
  ↓ FK: expemplref = bankexpref
bank_and_transactions (bankexpref PRIMARY KEY)
  ↓ FK: bankexpref = compbankref
credit_and_compliance (compbankref PRIMARY KEY)
  ↓ FK: compbankref = histcompref
credit_accounts_and_history (histcompref PRIMARY KEY)
```

## ⚠️ RULE: NEVER skip tables in the chain
If you need columns from Table A and Table C:
- You MUST include ALL intermediate tables (A → B → C)
- Skipping breaks the FK relationships

Example: Need `core_record.clientref` AND `credit_accounts_and_history.custlifeval`
→ MUST include ALL 5 intermediate JOINs

## ⚠️ RULE: Join Direction is Always Left-to-Right
```sql
FROM core_record cr
JOIN employment_and_income ei ON cr.coreregistry = ei.emplcoreref
JOIN expenses_and_assets ea ON ei.emplcoreref = ea.expemplref
JOIN bank_and_transactions bt ON ea.expemplref = bt.bankexpref
JOIN credit_and_compliance cc ON bt.bankexpref = cc.compbankref
JOIN credit_accounts_and_history cah ON cc.compbankref = cah.histcompref
```

## ⚠️ RULE: Common Mistakes
**WRONG:** `ON cc.compbankref = ei.emplcoreref` (skips ea, bt)
**WRONG:** `ON cr.coreregistry = cc.compbankref` (skips all intermediate)
**CORRECT:** Follow the chain exactly as shown above

## ✓ When You Can Stop the Chain
You can stop at an intermediate table if you don't need downstream data:
- Need core_record + employment_and_income? → Join to employment_and_income, stop
- Need core_record + expenses_and_assets? → Join through employment_and_income

But if you jump across the chain (e.g., core → credit_compliance), it fails.

# METRIC CALCULATION FORMULAS

When a question asks for a calculated metric, use these exact formulas:

## Debt-to-Income Ratio (DTI)
**Definition:** Calculates the proportion of a customer's monthly income that goes toward debt payments.
**Formula:** DTI = \frac{\text{Total Monthly Debt Payments}}{\text{Monthly Income}} = debincratio

## Credit Utilization Ratio (CUR)
**Definition:** Measures how much of available credit a customer is currently using.
**Formula:** CUR = \frac{\text{Total Credit Used}}{\text{Total Credit Limit}} = credutil

## Loan-to-Value Ratio (LTV)
**Definition:** Calculates the ratio of loan amount to the value of the asset securing the loan.
**Formula:** LTV = \frac{\text{Mortgage Balance}}{\text{Property Value}} = \frac{\text{propfinancialdata.mortgagebits.mortbalance}}{\text{propfinancialdata.propvalue}}

## Customer Lifetime Value (CLV)
**Definition:** Measures the total worth of a customer to the financial institution over the entire relationship.
**Formula:** CLV = custlifeval, which factors in product usage, tenure, profitability, and expected future transactions.

## Net Worth
**Definition:** Calculates the financial value of a customer by subtracting liabilities from assets.
**Formula:** Net Worth = \text{Total Assets} - \text{Total Liabilities} = totassets - totliabs = networth

## Credit Health Score (CHS)
**Definition:** Composite score measuring overall credit wellness based on multiple factors.
**Formula:** CHS = 0.4 × \frac{credscore}{850} + 0.2 × (1 - credutil) + 0.2 × (1 - debincratio) + 0.1 × \frac{credageyrs}{20} + 0.1 × (1 - \frac{delinqcount + latepaycount + choffs + bankr}{10}), \text{where each component is capped at 1.0}

## Financial Stability Index (FSI)
**Definition:** Measures a customer's overall financial stability combining income, savings, and debt factors.
**Formula:** FSI = 0.3 × (1 - debincratio) + 0.3 × \frac{liqassets}{mthincome × 6} + 0.2 × \frac{bankaccbal}{mthincome × 3} + 0.2 × \frac{savamount}{mthincome × 12}, \text{where each component is capped at 1.0}

## Customer Engagement Score (CES)
**Definition:** Quantifies how actively a customer uses bank products and services.
**Formula:** CES = 0.4 × produsescore + 0.3 × chanusescore + 0.2 × bankrelscore + 0.1 × \frac{custservint}{10}, \text{where each component is capped at 1.0}

## Risk-Adjusted Return (RAR)
**Definition:** Measures the profitability of a customer relationship adjusted for credit risk.
**Formula:** RAR = profitscore × (1 - \frac{risklev}{4}), \text{where risklev is converted to a numeric scale: Low=1, Medium=2, High=3, Very High=4}

## Account Health Index (AHI)
**Definition:** Composite measure of account quality considering age, mix, and payment history.
**Formula:** AHI = 0.4 × \frac{avgaccage}{10} + 0.3 × accmixscore + 0.3 × payconsist, \text{where each component is capped at 1.0}

## Total Debt Service Ratio (TDSR)
**Definition:** Extended debt ratio that accounts for all financial obligations including housing costs.
**Formula:** TDSR = DTI + \frac{\text{Housing Costs}}{\text{Monthly Income}}, \text{where Housing Costs are determined by propfinancialdata and DTI is the Debt-to-Income Ratio}

## Credit Quality Index (CQI)
**Definition:** Comprehensive measure of overall credit quality incorporating credit score and utilization.
**Formula:** CQI = 0.6 × \frac{credscore}{850} + 0.4 × (1 - CUR), \text{where CUR is the Credit Utilization Ratio}

## Housing Affordability Ratio (HAR)
**Definition:** Measures the affordability of housing costs relative to income.
**Formula:** HAR = \frac{\text{Monthly Housing Payment}}{\text{Monthly Income}} × 100\%, \text{where Monthly Housing Payment is derived from propfinancialdata and LTV calculations}

## Financial Vulnerability Score (FVS)
**Definition:** Quantifies financial fragility by combining debt burden and savings adequacy.
**Formula:** FVS = 0.5 × DTI + 0.5 × (1 - \frac{liqassets}{mthincome × 6}), \text{where DTI is the Debt-to-Income Ratio and the second term measures emergency fund adequacy}

## Customer Retention Risk (CRR)
**Definition:** Calculates risk of customer attrition based on engagement and satisfaction metrics.
**Formula:** CRR = 0.4 × churnrate + 0.3 × (1 - CES) + 0.3 × \frac{complainthist}{3}, \text{where CES is the Customer Engagement Score and complainthist is converted to numeric (Low=1, Medium=2, High=3)}

## Asset Liquidity Ratio (ALR)
**Definition:** Measures the proportion of customer assets that can be quickly converted to cash.
**Formula:** ALR = \frac{liqassets}{totassets} = \frac{liqassets}{Net Worth + totliabs}, \text{where Net Worth is the difference between assets and liabilities}

## Credit Risk Intensity (CRI)
**Definition:** Advanced measure of credit risk that incorporates payment history and account diversity.
**Formula:** CRI = 0.5 × (1 - \frac{credscore}{850}) + 0.3 × \frac{delinqcount + latepaycount + choffs}{10} + 0.2 × (1 - AHI), \text{where AHI is the Account Health Index}

## Investment Portfolio Quality (IPQ)
**Definition:** Evaluates the quality and performance of customer's investment allocations.
**Formula:** IPQ = 0.4 × RAR + 0.4 × \frac{investamt}{totassets} + 0.2 × \frac{chaninvdatablock.invcluster.investexp}{3}, \text{where RAR is the Risk-Adjusted Return and investexp is converted to numeric (Limited=1, Moderate=2, Extensive=3)}

## Banking Relationship Strength (BRS)
**Definition:** Quantifies the depth and quality of a customer's banking relationship.
**Formula:** BRS = 0.3 × bankrelscore + 0.3 × (1 - churnrate) + 0.4 × CES, \text{where CES is the Customer Engagement Score}

## Credit Health Momentum (CHM)
**Definition:** Measures the trajectory of a customer's credit health over time.
**Formula:** CHM = CHS × (1 + \Delta_\text{recentbeh}), \text{where CHS is the Credit Health Score and } \Delta_\text{recentbeh} \text{ is +0.1 for 'Improving', 0 for 'Stable', and -0.1 for 'Deteriorating'}

# MULTI-LEVEL AGGREGATION PATTERNS

## Pattern: Questions with Nested Grouping & Multiple Percentages

### Recognition: When Question Asks for TWO Different % Metrics
Question patterns:
- 'percentage of the cohort' (overall) + 'broken down by [dimension]' (segment-specific)
- 'overall %' + 'per-group %'
- 'total rate' + '[subgroup] rate'

**This ALWAYS requires:**
1. GROUP BY dimension1 (e.g., cohort_quarter)
2. GROUP BY dimension1, dimension2 (e.g., cohort_quarter + is_digital_native)
3. Relate both aggregations to show overall + segment metrics

### Key Decision: CTE or JOIN Approach?

**Use CTEs when:**
- You need multiple different GROUP BY clauses
- Calculations are complex and reused
- You want to compute 'total' metrics separately

**Structure:**
```
CTE 1: Base calculations (row-level)
CTE 2: Level-1 grouping (dimension1 only)
CTE 3+: Level-2 grouping (dimension1 + dimension2)
Final SELECT: JOIN CTEs to combine metrics
```

### Percentage Calculation Rule
When dividing for percentages:
```sql
-- ALWAYS cast numerator to REAL to avoid integer division
CAST(SUM(CASE WHEN condition THEN 1 ELSE 0 END) AS REAL) / COUNT(*)

-- Or equivalently:
SUM(CASE WHEN condition THEN 1.0 ELSE 0.0 END) / COUNT(*)
```

### NULL Handling for Segment Percentages
When segment may be empty (e.g., no digital natives):
```sql
-- DON'T return division by zero; return NULL instead
CAST(...sum... AS REAL)
/ CASE WHEN denominator = 0 THEN NULL ELSE denominator END
```

### Example Pattern Recognition
**Question:** 'Show cohort quarter, digital native status, and BOTH the overall cohort % high-engagement AND the segment-specific % high-engagement'

**Decompose into:**
1. What's the base row unit? → Customer (one row per customer)
2. What are the dimensions? → cohort_quarter + is_digital_native
3. What metric? → has high engagement? (binary) + score (continuous)
4. What % requested?
   - Overall: (high_engagement_count in cohort) / (total customers in cohort)
   - Segment: (high_engagement_count in segment) / (total customers in segment)

**Architecture:**
- CTE 1: Select all customers with calculated metrics
- CTE 2: GROUP BY cohort_quarter ONLY → pct_overall
- CTE 3: GROUP BY cohort_quarter + is_digital_native → pct_segment
- Final: JOIN CTE2 + CTE3 to show both %s together

## Pattern: Calculated Metrics with Multiple Dependencies
When metric requires columns from different tables:

**Example:** CES = 0.4*produsescore + 0.3*chanusescore + 0.2*bankrelscore + 0.1*(custservint/10)
- produsescore, chanusescore, custservint → from credit_accounts_and_history
- bankrelscore → from bank_and_transactions
- Requires: JOIN both tables

**Rule:** Calculate once in base CTE, reference in aggregations
```sql
WITH base AS (
  SELECT
    ..., 
    0.4*t1.metric1 + 0.3*t1.metric2 + 0.2*t2.metric3 + ... AS calculated_metric
  FROM table1 t1
  JOIN table2 t2 ON ...
),
aggregated AS (
  SELECT
    group_col,
    COUNT(*) AS count,
    AVG(calculated_metric) AS avg_metric
  FROM base
  GROUP BY group_col
)
SELECT ... FROM aggregated;
```


---

# BSL OVERRIDES (MANUAL)

Terminology:
- Treat "digital native" as "Digital First Customer" unless the user defines another rule.

Net worth:
- When net worth is required, compute it as totassets - totliabs.
- Do not use expenses_and_assets.networth unless explicitly requested.

Property leverage (LTV / mortgage ratio):
- When the question asks for property leverage/ratio and all needed fields are in expenses_and_assets.propfinancialdata:
  use expenses_and_assets.expemplref as customer_id.
- Query directly from expenses_and_assets; do not join core_record or employment_and_income.
- Compute ratio = mortgage_balance / property_value using JSON fields.
- Exclude NULL or zero property_value and NULL mortgage_balance.
- Order by the ratio descending.

Credit classification defaults:
- If a question asks for credit classification WITHOUT explicit customer detail fields, return a summary:
  credit_category, customer_count, average_credscore (GROUP BY credit_category).
- If explicit customer detail fields are listed (e.g., customer_id, scoredate, risklev), return row-level records
  with credit_category included (no GROUP BY).

Digital engagement cohort summary:
- If a question asks for digital engagement by cohort and digital-native status without a concrete time window
  (explicit years or quarters), return a two-row summary grouped only by is_digital_native with:
  cohort_size, avg_engagement (CES), pct_high_engagement (CES > 0.7).
- If the question says "quarterly cohorts" but no explicit years/quarters are given, do not include cohort_quarter in output.
- Only use cohort_quarter or time-series when a concrete time range is explicitly requested.
- If this conflicts with generic cohort rules, prefer this section.

Defaults for vague thresholds:
- Do not use SQL parameter placeholders (?,?,:name,@name,$name). Use explicit numeric literals.
- If a question says "few customers" without a threshold, default to HAVING COUNT(*) >= 10.