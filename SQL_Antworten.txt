1.
SELECT
  cr.clientref AS customer_id,
  ea.totassets AS total_assets,
  ea.totliabs AS total_liabilities,
  (ea.totassets - ea.totliabs) AS computed_net_worth,
  DENSE_RANK() OVER (ORDER BY (ea.totassets - ea.totliabs) DESC) AS wealth_rank
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
ORDER BY computed_net_worth DESC
LIMIT 10



2.
SELECT DISTINCT cr.clientref
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
JOIN bank_and_transactions AS bt
  ON bt.bankexpref = ea.expemplref
WHERE (
    json_extract(bt.chaninvdatablock, '$.onlineuse') = 'High'
    OR json_extract(bt.chaninvdatablock, '$.mobileuse') = 'High'
  )
  AND json_extract(bt.chaninvdatablock, '$.autopay') = 'Yes'



3.
SELECT
  cr.clientref AS customer_id,
  ea.investamt AS investment_amount,
  ea.totassets AS total_assets
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
JOIN bank_and_transactions AS bt
  ON bt.bankexpref = ea.expemplref
WHERE
  json_extract(bt.chaninvdatablock, '$.invcluster.investport') IN ('Moderate', 'Aggressive')
  AND json_extract(bt.chaninvdatablock, '$.invcluster.investexp') = 'Extensive'
  AND ea.investamt > 0.3 * ea.totassets



4.
SELECT
  CASE
    WHEN cc.credscore BETWEEN 300 AND 579 THEN 'Poor'
    WHEN cc.credscore BETWEEN 580 AND 669 THEN 'Fair'
    WHEN cc.credscore BETWEEN 670 AND 739 THEN 'Good'
    WHEN cc.credscore BETWEEN 740 AND 799 THEN 'Very Good'
    WHEN cc.credscore BETWEEN 800 AND 850 THEN 'Excellent'
    ELSE 'Unknown'
  END AS credit_category,
  cr.clientref,
  cr.clientseg,
  cr.agespan,
  cr.scoredate,
  cr.decidestat,
  cr.decidedate,
  cc.credscore,
  cc.risklev,
  cc.defhist,
  cc.delinqcount,
  cc.latepaycount
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
JOIN bank_and_transactions AS bt
  ON bt.bankexpref = ea.expemplref
JOIN credit_and_compliance AS cc
  ON cc.compbankref = bt.bankexpref
ORDER BY
  credit_category,
  cc.credscore DESC,
  cr.clientref



5.
SELECT
  cr.clientref AS customer_id,
  CAST(json_extract(ea.propfinancialdata, '$.propvalue') AS REAL) AS property_value,
  CAST(json_extract(ea.propfinancialdata, '$.mortgagebits.mortbalance') AS REAL) AS mortgage_balance,
  CASE
    WHEN CAST(json_extract(ea.propfinancialdata, '$.propvalue') AS REAL) IS NULL
      OR CAST(json_extract(ea.propfinancialdata, '$.propvalue') AS REAL) = 0
      OR CAST(json_extract(ea.propfinancialdata, '$.mortgagebits.mortbalance') AS REAL) IS NULL
    THEN NULL
    ELSE CAST(json_extract(ea.propfinancialdata, '$.mortgagebits.mortbalance') AS REAL)
         / CAST(json_extract(ea.propfinancialdata, '$.propvalue') AS REAL)
  END AS ltv_ratio
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
WHERE json_extract(ea.propfinancialdata, '$.propvalue') IS NOT NULL
  AND json_extract(ea.propfinancialdata, '$.mortgagebits.mortbalance') IS NOT NULL



6.
SELECT
  cr.clientref AS customer_id,
  cr.coreregistry AS core_registry_id,
  cr.agespan,
  cr.tenureyrs,
  cr.crossratio,
  cr.profitscore,
  cr.churnrate,
  ei.emplstat,
  ei.mthincome,
  ei.annlincome,
  ei.hshincome,
  ei.addincome,
  ei.incstabscore,
  ei.debincratio,
  ea.mthexp,
  ea.liqassets,
  ea.savamount,
  ea.investamt,
  ea.totassets,
  ea.totliabs,
  ea.networth,
  ea.bankacccount,
  ea.bankaccage,
  ea.bankaccbal,
  bt.banktxfreq,
  bt.banktxamt,
  bt.bankrelscore,
  bt.ovrfreq,
  bt.bouncecount,
  bt.idverscore,
  bt.kycstat,
  bt.amlresult,
  cc.credscore,
  cc.risklev,
  cc.defhist,
  cc.delinqcount,
  cc.latepaycount,
  cc.hardinq,
  cc.softinq,
  cc.credageyrs,
  cai.newaccage,
  cai.avgaccage,
  cai.accmixscore,
  cai.payconsist,
  cai.seekbeh,
  cai.cardcount,
  cai.totcredlimit,
  cai.credlimusage,
  cai.credutil,
  cai.loancount,
  cai.activeloan,
  cai.totloanamt,
  cai.produsescore,
  cai.chanusescore,
  cai.custservint,
  cai.custlifeval
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
JOIN bank_and_transactions AS bt
  ON bt.bankexpref = ea.expemplref
JOIN credit_and_compliance AS cc
  ON cc.compbankref = bt.bankexpref
JOIN credit_accounts_and_history AS cai
  ON cai.histcompref = cc.compbankref



7.
WITH user_base AS (
  SELECT
    u.userkey,
    u.regmoment,
    u.ageval,
    -- registration quarter cohort
    (CAST(strftime('%Y', u.regmoment) AS INTEGER) || '-Q' || ((CAST(strftime('%m', u.regmoment) AS INTEGER) - 1) / 3 + 1)) AS cohort_quarter,
    -- tenure in days (approx, relative to query run time)
    CAST((julianday('now') - julianday(u.regmoment)) AS INTEGER) AS tenure_days,
    CASE
      WHEN (julianday('now') - julianday(u.regmoment)) < 90 THEN '0-89d'
      WHEN (julianday('now') - julianday(u.regmoment)) < 180 THEN '90-179d'
      WHEN (julianday('now') - julianday(u.regmoment)) < 365 THEN '180-364d'
      ELSE '365d+'
    END AS tenure_cohort,
    CASE WHEN u.ageval <= 30 THEN 1 ELSE 0 END AS is_digital_native
  FROM users u
  WHERE u.regmoment IS NOT NULL
),
uer_per_user AS (
  SELECT
    ub.userkey,
    ub.cohort_quarter,
    ub.tenure_cohort,
    ub.is_digital_native,
    AVG( (s.seshviews * s.engscore) * 1.0 / NULLIF(s.seshdur, 0) ) AS avg_uer
  FROM user_base ub
  LEFT JOIN sessions s
    ON s.userel = ub.userkey
  GROUP BY
    ub.userkey,
    ub.cohort_quarter,
    ub.tenure_cohort,
    ub.is_digital_native
),
uer_threshold AS (
  -- overall median UER as the "high engagement" threshold
  SELECT
    AVG(avg_uer) AS high_engagement_uer_threshold
  FROM (
    SELECT avg_uer
    FROM uer_per_user
    WHERE avg_uer IS NOT NULL
    ORDER BY avg_uer
    LIMIT 2 - (SELECT COUNT(*) FROM uer_per_user WHERE avg_uer IS NOT NULL) % 2
    OFFSET (SELECT (COUNT(*) - 1) / 2 FROM uer_per_user WHERE avg_uer IS NOT NULL)
  )
),
cohort_stats AS (
  SELECT
    upu.cohort_quarter,
    upu.tenure_cohort,
    upu.is_digital_native,
    COUNT(*) AS cohort_size,
    AVG(COALESCE(upu.avg_uer, 0.0)) AS engagement_score,
    100.0 * AVG(
      CASE
        WHEN upu.avg_uer IS NOT NULL
         AND upu.avg_uer >= (SELECT high_engagement_uer_threshold FROM uer_threshold)
        THEN 1.0 ELSE 0.0
      END
    ) AS pct_high_engagement
  FROM uer_per_user upu
  GROUP BY
    upu.cohort_quarter,
    upu.tenure_cohort,
    upu.is_digital_native
),
cohort_totals AS (
  -- totals per cohort (quarter + tenure), used to show overall high-engagement % alongside the digital-native split
  SELECT
    upu.cohort_quarter,
    upu.tenure_cohort,
    COUNT(*) AS cohort_size_total,
    100.0 * AVG(
      CASE
        WHEN upu.avg_uer IS NOT NULL
         AND upu.avg_uer >= (SELECT high_engagement_uer_threshold FROM uer_threshold)
        THEN 1.0 ELSE 0.0
      END
    ) AS pct_high_engagement_total
  FROM uer_per_user upu
  GROUP BY
    upu.cohort_quarter,
    upu.tenure_cohort
)
SELECT
  cs.cohort_quarter,
  cs.tenure_cohort,
  cs.is_digital_native,
  cs.cohort_size,
  cs.engagement_score,
  ct.pct_high_engagement_total AS pct_high_engagement_in_cohort,
  cs.pct_high_engagement AS pct_high_engagement_by_digital_native_status
FROM cohort_stats cs
JOIN cohort_totals ct
  ON ct.cohort_quarter = cs.cohort_quarter
 AND ct.tenure_cohort = cs.tenure_cohort
ORDER BY
  cs.cohort_quarter,
  cs.tenure_cohort,
  cs.is_digital_native



8.
WITH seg_stats AS (
  SELECT
    cr.clientseg AS segment,
    COUNT(*) AS customer_count,
    AVG(ei.debincratio) AS avg_dti,
    AVG(ea.totliabs) AS avg_total_liabilities,
    AVG(ea.networth) AS avg_net_worth,
    AVG(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 THEN ea.totliabs / ei.mthincome END) AS avg_liabilities_to_monthly_income,
    SUM(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 AND ei.debincratio > 0.43 THEN 1 ELSE 0 END) AS cnt_dti_over_0_43,
    SUM(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 AND ei.debincratio > 0.50 THEN 1 ELSE 0 END) AS cnt_dti_over_0_50
  FROM core_record cr
  JOIN employment_and_income ei
    ON cr.coreregistry = ei.emplcoreref
  JOIN expenses_and_assets ea
    ON ei.emplcoreref = ea.expemplref
  GROUP BY cr.clientseg
  HAVING COUNT(*) >= 10
), results AS (
  SELECT
    segment,
    customer_count,
    avg_dti,
    avg_total_liabilities,
    avg_net_worth,
    avg_liabilities_to_monthly_income,
    cnt_dti_over_0_43,
    cnt_dti_over_0_50
  FROM seg_stats

  UNION ALL

  SELECT
    'Grand Total' AS segment,
    COUNT(*) AS customer_count,
    AVG(ei.debincratio) AS avg_dti,
    AVG(ea.totliabs) AS avg_total_liabilities,
    AVG(ea.networth) AS avg_net_worth,
    AVG(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 THEN ea.totliabs / ei.mthincome END) AS avg_liabilities_to_monthly_income,
    SUM(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 AND ei.debincratio > 0.43 THEN 1 ELSE 0 END) AS cnt_dti_over_0_43,
    SUM(CASE WHEN ei.mthincome IS NOT NULL AND ei.mthincome <> 0 AND ei.debincratio > 0.50 THEN 1 ELSE 0 END) AS cnt_dti_over_0_50
  FROM core_record cr
  JOIN employment_and_income ei
    ON cr.coreregistry = ei.emplcoreref
  JOIN expenses_and_assets ea
    ON ei.emplcoreref = ea.expemplref
)
SELECT
  segment,
  customer_count,
  avg_dti,
  avg_total_liabilities,
  avg_net_worth,
  avg_liabilities_to_monthly_income,
  cnt_dti_over_0_43,
  cnt_dti_over_0_50
FROM results
ORDER BY
  CASE WHEN segment = 'Grand Total' THEN 1 ELSE 0 END,
  avg_dti DESC,
  customer_count DESC,
  segment ASC;



9.
SELECT
  cr.clientref AS customer_id,
  ea.liqassets AS liquid_assets,
  ea.totassets AS total_assets,
  CASE
    WHEN ea.totassets IS NULL OR ea.totassets = 0 THEN NULL
    ELSE ea.liqassets * 1.0 / ea.totassets
  END AS liquidity_measure_alr,
  ei.mthincome AS monthly_income,
  ea.investamt AS investment_amount,
  CASE
    WHEN ea.totassets IS NULL OR ea.totassets = 0 THEN 'Unknown'
    WHEN (ea.liqassets * 1.0 / ea.totassets) > 0.3 AND ei.mthincome > 5000 THEN 'Investment Services Target'
    ELSE 'Standard'
  END AS investment_potential_label
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
ORDER BY cr.clientref



10.
SELECT
  cr.clientref AS customer_id,
  (
    0.5 * ei.debincratio
    + 0.5 * (
      1.0 - (ea.liqassets / (ei.mthincome * 6.0))
    )
  ) AS vulnerability_score,
  ea.networth AS net_worth,
  cc.delinqcount AS delinquency_count,
  cc.latepaycount AS late_payment_count
FROM core_record AS cr
JOIN employment_and_income AS ei
  ON ei.emplcoreref = cr.coreregistry
JOIN expenses_and_assets AS ea
  ON ea.expemplref = ei.emplcoreref
JOIN bank_and_transactions AS bt
  ON bt.bankexpref = ea.expemplref
JOIN credit_and_compliance AS cc
  ON cc.compbankref = bt.bankexpref
WHERE (
    0.5 * ei.debincratio
    + 0.5 * (1.0 - (ea.liqassets / (ei.mthincome * 6.0)))
  ) > 0.7
  AND (cc.delinqcount > 0 OR cc.latepaycount > 0)
  AND ea.networth < 0